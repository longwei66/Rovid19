---
title: "Analysing COVID-19 (2019-nCoV) outbreak in France"
draft: true
description: "A further exploration of COVID-19 incidence data using R tools and packages."
categories:
  - R
  - "COVID-19"
author:
  - name: Barthélémy Longueville for datapleth.io
creative_commons: CC BY-SA
twitter:
  creator: "@datapleth"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 3
    self_contained: true
    number_sections: true
---

```{r loadLibs, include=FALSE}
library(tidyverse)
library(data.table)
library(kableExtra)
library(DT)
library(RColorBrewer)
library(ggplot2)
library(gghighlight)
library(plotly)
library(patchwork)
library(shadowtext)

library(gt)
library(deSolve)
library(EpiEstim)
library(incidence)
library(distcrete)
library(epitrix)
library(projections)
library(earlyR)
library(distill)

knitr::opts_chunk$set(fig.width=9, fig.height=9, echo=FALSE, warning = FALSE, message = FALSE)
# Remove scientific notation
options(scipen=999)
```




# Introduction & Objectives

This documents provides an analysis of Covid-19 outbreak in France based on 
offical data, and community data. We also include some comparison with other
countries such as Italy.

We will use different types and granularity of data such as :

- number of covid-19 case at country level
- official hospital daily data (back home, currently hospitalized, currently in ICU & deaths), at country, region, department levels
- officiel emergency daily data (ER visits, ER visits for covid, hospitalization for covid-19, SOS médecins act, SOS médecins covid-19 acts) at country, regional and department levels.
- official tests done at country, region and department levels.

Another report of this project is focusing on mortality (see references).

Visualisation and some elements of code are inspired by the best reference we
found during this period :

- John Burn-Murdoch ( @jburnmurdoch ) who is a senior dataviz journalist at ft.com (see [his work here](https://www.ft.com/coronavirus-latest))
- Tim Churches with scientist at South Western Sydney Clinical School, UNSW 
Medicine & Ingham Institute of Applied Medical Research, Liverpool, Sydney, 
Australia. ( [link](https://swscs.med.unsw.edu.au) and his 
work [here](https://timchurches.github.io/blog/))

This report is published under creative common CC BY-SA, and code should be
GPL 3.0



# Covid-19 Data - France and other countries

## Wordlwide cases and deaths - John Hopkings 

Over the weeks, one accademic source of data became the reference, it's issued
by John Hopkings University and released on github.

### Number of cases  {.tabset .tabset-fade .tabset-pills} 

#### Cumulative cases per countries

```{r getJHUCasesCum, include=FALSE}
www_cases_cum <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv") %>%
  gather(date, cases, 5:ncol(.)) %>%
  mutate(date = as.Date(date, "%m/%d/%y"))  %>%
  group_by(country = `Country/Region`, date) %>%
  summarise(cases = sum(cases)) %>%
  as.data.table()
```

The first dataset availabe records cumulatives cases per countrys/regions. We
compile the data only per country.


```{r viewJHUCasesCum, echo=FALSE}
DT::datatable(
  tail(www_cases_cum,400)
  , filter = 'top'
  , class = 'cell-border stripe'
  , options = list(
    dom = 't'
    , scrollX = TRUE
    , scrollCollapse = TRUE
  )
)
```

#### Daily cases per countries

```{r getJHUCasesDaily, include=FALSE}
www_cases_daily <- www_cases_cum %>%
  group_by(country) %>%
  arrange( cases ) %>%
  mutate(
    daily_cases = c(cases[1], (cases - lag(cases))[-1])
  ) %>%
  ungroup() %>%
  as.data.table()
```


```{r viewJHUCasesDaily, echo=FALSE}
DT::datatable(
  tail(www_cases_cum,900)
  , filter = 'top'
  , class = 'cell-border stripe'
  , options = list(
    dom = 't'
    , scrollX = TRUE
    , scrollCollapse = TRUE
  )
)
```


### Deaths per countries (cumulated)

```{r getJHUDeaths}
www_deaths_cum <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv") %>%
  gather(date, cases, 5:ncol(.)) %>%
  mutate(date = as.Date(date, "%m/%d/%y")) %>%
  group_by(country = `Country/Region`, date) %>%
  summarise(cases = sum(cases)) 
```

The first dataset availabe records cumulatives deaths per countrys/regions. We
compile the data only per country.


```{r viewJHUDeaths, echo=FALSE}
DT::datatable(
  tail(www_deaths_cum,400),
  , filter = 'top'
  , class = 'cell-border stripe'
  , options = list(
    dom = 't'
    , scrollX = TRUE
    , scrollCollapse = TRUE
  )
)
```


### France community gathered offical cases data

#### Cumulative cases in France

```{r}
france_com_url <- "https://www.data.gouv.fr/fr/datasets/r/0b66ca39-1623-4d9c-83ad-5434b7f9e2a4"

france_com_cases_cum <- read.csv(file = france_com_url, stringsAsFactors = FALSE) %>%
  filter(source_nom == "Ministère des Solidarités et de la Santé" &
                            granularite == "pays") %>%
  select(date, cas_confirmes) %>%
  mutate(date = as.Date(date), country = "France") %>%
  rename( cases = cas_confirmes) %>%
  as.data.table()
```

Let's compare JHU data with french offical data. Seems there is an issue in 
data from JHU for Cumulated cases. We will use official french data which 
seems to be more reliable (there is a big jump in cases mid april).

```{r compareJHUFrance, echo=FALSE}
g <- ggplot()
g <- g + geom_point(data = www_cases_cum[ country == "France"], aes(x = date, y = cases), color = "firebrick")
g <- g + geom_point(data = france_com_cases_cum, aes(x = date, y = cases), color = "darkblue")
g + ylab("Daily cum covid-19 cases") + ggtitle(label = "Cumulative cases of covid-19 in France", subtitle = "Red - JHU data, Blue, French official")
```





#### Daily cases in France

```{r getFrasesDaily, include=FALSE}
france_com_cases_daily <- france_com_cases_cum %>%
  arrange( cases ) %>%
  mutate(
    daily_cases = c(cases[1], (cases - lag(cases))[-1])
  ) %>%
  ungroup() %>%
  as.data.table()
```

#### Daily cases in France smoothed on3 days

```{r makeDailyAvera}
france_com_cases_daily_smooth <- copy(france_com_cases_daily)
france_com_cases_daily_smooth[ , daily_cases :=data.table::frollmean(france_com_cases_daily[, daily_cases], 3) ]
```



We compare these data with JHU data and clearly see the outlier in the reporting.


```{r compareJHUFranceDaily, echo=FALSE}
h <- ggplot()
h <- h + geom_point(data = www_cases_daily[ country == "France"], aes(x = date, y = daily_cases), color = "firebrick")
h <- h + geom_point(data = france_com_cases_daily, aes(x = date, y = daily_cases), color = "darkblue")
h <- h + geom_point(data = france_com_cases_daily, aes(x = date, y = daily_cases), color = "darkgreen")
h <- h + ylab("Daily covid-19 cases") + ggtitle(label = "Daily cases of covid-19 in France", subtitle = "Red - JHU data, Blue, French official")
h
```



```{r viewFRCasesDaily, echo=FALSE}
DT::datatable(
  france_com_cases_daily
  , filter = 'top'
  , class = 'cell-border stripe'
  , options = list(
    dom = 't'
    , scrollX = TRUE
    , scrollCollapse = TRUE
  )
)
```

## Official France Data - Hospital - Emergency - Tests
### Hospital data (official) {.tabset .tabset-fade .tabset-pills} 

#### Data Sources

Since Friday march 27th, French government is publishing data for hospital and
health network.

From [data.gouv.fr](https://www.data.gouv.fr/fr/datasets/donnees-hospitalieres-relatives-a-lepidemie-de-covid-19/)

> Le présent jeu de données renseigne sur la situation hospitalières concernant
> l'épidémie de COVID-19 :

> Deux fichiers sont proposés :

> 1/ Les données hospitalières quotidiennes relatives à l'épidémie du COVID-19 par 
> département et sexe du patient : nombre de patients hospitalisés, nombre de 
> personnes actuellement en réanimation ou soins intensifs, nombre cumulé de 
> personnes retournées à domicile, nombre cumulé de personnes décédées.

> 2/ Les données quotidiennes relatives aux établissements hospitaliers par
> département : nombre cumulé de services ayant déclaré au moins un cas.
> Pour chacun des fichiers, une fiche de métadonnées est proposée.

> Attention : certains fichiers peuvent également comporter des anomalies. 
> N'hésitez pas à les signaler en commentaire. Santé publique France 
> communiquera les anomalies aux services métiers.


```{r sourceUriHosp}
france_official_hospital_dep_url <- "https://www.data.gouv.fr/fr/datasets/r/63352e38-d353-4b54-bfd1-f1b3ee1cabd7"
france_official_hospital_dep_codebook_url <- "https://www.data.gouv.fr/fr/datasets/r/3f0f1885-25f4-4102-bbab-edec5a58e34a"

france_region_departements_url <- "https://www.data.gouv.fr/en/datasets/r/987227fb-dcb2-429e-96af-8979f97c9c84"
```

Autres data - mortalité
https://www.insee.fr/fr/information/4470857#tableau-figure2_radio1


#### Data Struture

```{r loadCleanFranceOfficialCodebook, echo=FALSE}
france_official_hospital_dep_codebook <- data.table::as.data.table(read.csv(file = france_official_hospital_dep_codebook_url, sep = ";"))

france_official_hospital_dep_codebook %>%
  rename(Feature = Colonne) %>%
  mutate(Feature = c( "departement", "sex", "date", "hospitalized_now", "icu_now", "returned_home_now", "death_cum")) -> france_official_hospital_dep_codebook

france_official_hospital_dep_codebook %>%
  select(-Description_FR) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

We import these data and merge associate department with their Region names

```{r}
france_official_hospital_dep <- data.table::as.data.table(read.csv(file = france_official_hospital_dep_url, sep = ";"))
france_region_departements <- data.table::as.data.table(read.csv(file = france_region_departements_url, sep = ","))
france_official_hospital_dep %>% 
  rename(
    department = dep
    , sex = sexe
    , date = jour
    , hospitalized_now = hosp
    , icu_now = rea
    , back_home_now = rad
    , death_cum = dc
  ) %>%
  mutate(
    date = as.Date(date)
  )-> france_official_hospital_dep

france_official_hospital_dep <- data.table::as.data.table(merge(
  france_official_hospital_dep
  , france_region_departements
  , by.x = "department"
  , by.y = "num_dep"
))
```



#### Data per department

```{r viewHospitalDataPerDep}
DT::datatable(france_official_hospital_dep
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```

#### Data per regions

We combine now department data per region.

```{r agregateHospPerRegion}
france_official_hospital_dep %>%
  group_by(region_name,sex,date) %>%
  summarise(
    hospitalized_now = sum(hospitalized_now, na.rm=TRUE)
    , icu_now = sum(icu_now, na.rm = TRUE)
    , back_home_now = sum(back_home_now, na.rm = TRUE)
    , death_cum = sum(death_cum, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  data.table::as.data.table()-> france_official_reg
```



```{r viewHospitalDataPerRegion}
DT::datatable(france_official_reg
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```

#### Data for France (Total)

We use department data to aggregate results at Country level

```{r agregateHospTotal}
france_official_hospital_dep %>%
  group_by(sex,date) %>%
  summarise(
    hospitalized_now = sum(hospitalized_now, na.rm=TRUE)
    , icu_now = sum(icu_now, na.rm = TRUE)
    , back_home_now = sum(back_home_now, na.rm = TRUE)
    , death_cum = sum(death_cum, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate( sex = as.factor(sex)) %>%
  data.table::as.data.table()-> france_official_hospital_total
```


```{r viewHospitalDataTotal}
DT::datatable(france_official_hospital_total
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```


### Emergency Data (official) {.tabset .tabset-fade .tabset-pills}

This covers emergency GP ( SOS Medecins ) & Hospital Emergency Wards, per region and per department.

#### Data Sources


Since Friday march 27th, French government is publishing data for hospital and
health network.

From [data.gouv.fr](https://www.data.gouv.fr/fr/datasets/donnees-des-urgences-hospitalieres-et-de-sos-medecins-relatives-a-lepidemie-de-covid-19/#_)


> Description du jeu de données
> Quatre fichiers sont proposés :

> Les données quotidiennes de SOS médecins et des urgences hospitalières par
> département, sexe et tranche d’âge des patients : nombre de passages aux
> urgences pour suspicion de COVID-19, nombre total de passages aux urgences,
> nombre d’hospitalisations parmi les passages aux urgences pour suspicion de
> COVID-19, nombre total d’actes médicaux SOS Médecins pour suspicion de
> COVID-19, nombre d’actes médicaux SOS Médecins.


> Les données quotidiennes de SOS médecins et des urgences hospitalières par
> région, sexe et tranches d’âge des patients : nombre de passages aux
> urgences pour suspicion de COVID-19, nombre total de passages aux urgences,
> nombre d’hospitalisations parmi les passages aux urgences pour suspicion de
> COVID-19, nombre d’actes médicaux SOS Médecins pour suspicion de COVID-19,
> nombre d’actes médicaux SOS Médecins total. Le code région correspond au
> code INSEE publié par l’INSEE sur www.data.gouv.fr.

```{r sourceUriEmergency}
france_official_emergency_dep_url <- "https://www.data.gouv.fr/fr/datasets/r/eceb9fb4-3ebc-4da3-828d-f5939712600a"
france_official_emergency_dep_codebook_url <- "https://www.data.gouv.fr/fr/datasets/r/2265d880-5260-4b34-8827-b3d76180032e"

france_official_emergency_reg_url <- "https://www.data.gouv.fr/fr/datasets/r/d2af5160-a21d-47b7-8f30-3c20dade63b1"
france_official_emergency_reg_codebook_url <- "https://www.data.gouv.fr/fr/datasets/r/02c99d99-96a0-4953-8e30-04fd660530f6"

france_official_emergency_total_url <- "https://www.data.gouv.fr/fr/datasets/r/219427ba-7e90-4eb1-9ac7-4de2e7e2112c"
france_official_emergency_total_codebook_url <- "https://www.data.gouv.fr/fr/datasets/r/0289e4fe-bb67-42b9-a320-cd22c98d82c3"



france_age_categories_url <- "https://www.data.gouv.fr/fr/datasets/r/cbed61a8-64e8-4c8c-8e97-65d3a31a99b6"

france_regions_url <- "https://data.opendatasoft.com/explore/dataset/contours-geographiques-tres-simplifies-des-regions-2019@ofgl-opendatamef/download/?format=csv&timezone=Europe/Berlin&use_labels_for_header=true&csv_separator=%3B"

```


#### Data Structure

Dataset per departments :

```{r loadCleanFranceOfficialERdepCodebook, echo=FALSE}
france_official_emergency_dep_codebook <- data.table::as.data.table(read.csv(file = france_official_emergency_dep_codebook_url, sep = ";", header = T, stringsAsFactors = F))
mynames <- as.character(france_official_emergency_dep_codebook[1])
setnames(france_official_emergency_dep_codebook, unlist(mynames))

france_official_emergency_dep_codebook %>%
  select(-Description_FR) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Dataset per Regions :

```{r loadCleanFranceOfficialERregCodebook, echo=FALSE}
france_official_emergency_reg_codebook <- data.table::as.data.table(read.csv(file = france_official_emergency_reg_codebook_url, sep = ";", header = T, stringsAsFactors = F))
mynames <- as.character(france_official_emergency_reg_codebook[1])
setnames(france_official_emergency_reg_codebook, unlist(mynames))

france_official_emergency_reg_codebook %>%
  select(-Description_FR) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Age categories

```{r getAgeCategories}
france_age_categories <- data.table::as.data.table(read.csv(file = france_age_categories_url, sep = ";", header = T, stringsAsFactors = F))
names(france_age_categories) <- c("category_code", "category_description")

france_age_categories %>%
  #select(-Description_FR) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```




#### Data per department


```{r}
france_official_emergency_dep <- data.table::as.data.table(read.csv(file = france_official_emergency_dep_url, sep = ","))
france_official_emergency_dep %>%
  mutate(date = as.Date(date_de_passage)) %>%
  as.data.table()-> france_official_emergency_dep

france_official_emergency_dep <- data.table::as.data.table(merge(
  france_official_emergency_dep
  , france_region_departements
  , by.x = "dep"
  , by.y = "num_dep"
))
```



```{r viewHospitalDataPerERDep}
DT::datatable(tail(france_official_emergency_dep,100)
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```


#### Data per regions


```{r}
france_official_emergency_reg <- data.table::as.data.table(read.csv(file = france_official_emergency_reg_url, sep = ","))


regions <- as.data.table(read.csv(
  file= france_regions_url
  , sep = ";"))
regions <- regions %>% 
  mutate( code_insee = Code.INSEE, region_name = Nom.région) %>%
  select(code_insee, region_name)

france_official_emergency_reg <- merge(
  x =france_official_emergency_reg
  , y = regions
  , by.x = "reg"
  , by.y = "code_insee")
```



```{r viewHospitalDataERPerReg}
DT::datatable(tail(france_official_emergency_reg,100)
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```



#### Data for France


```{r}
france_official_emergency_total <- read.csv(file = france_official_emergency_total_url, sep = ",", stringsAsFactors = TRUE) %>%
  mutate(
    date = as.Date(date_de_passage)
  ) %>%
  data.table::as.data.table()
```



```{r viewHospitalDataERTotal}
DT::datatable(tail(france_official_emergency_total,100)
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```




### Covid tests data (Official) {.tabset .tabset-face .tabset-pills}

This covers test data for tests done in city laboratory per department and age
range.

#### Data Sources


Since Monday April 6th, French government is publishing data for tests network.

From [data.gouv.fr](https://www.data.gouv.fr/fr/datasets/donnees-des-urgences-hospitalieres-et-de-sos-medecins-relatives-a-lepidemie-de-covid-19/#_)

> Le présent jeu de données renseigne sur le nombre de tests de dépistage du 
> COVID-19 réalisés par les laboratoires de villes, par département et par sexe :

> Nombre de tests réalisés ;
> Nombre de tests positifs.
> Un fichier quotidien et un fichier hebdomadaire sont proposés.

> Mode de production des données
> Le système de surveillance, appelé 3labos, repose sur la remontée automatisée 
> des données individuelles de trois laboratoires centralisateurs de 
> prélèvements (France métropolitaine et DOM) : Eurofins Biomnis et Cerba. Les 
> objectifs de ce système de surveillance sont le suivi des tendances 
> temporo-spatiales de maladies infectieuses ciblées, la contribution à 
> l’investigation d’épidémies et l’apport de données complémentaires aux 
> systèmes de surveillance existants.

> Dans le cadre de l'épidémie de COVID-19, des données sont transmises 
> quotidiennement et incluent le résultat biologique (réalisé par PCR), l’âge, 
> le sexe et le département du patient ou du laboratoire préleveur.

> Les données sont transmises quotidiennement à Santé publique France, avec un 
> certain délai entre la date de prélèvement et la réalisation du test. Ces 
> délais comprennent le temps d’acheminement de l’échantillon, la réalisation 
> du test, le traitement administratif du dossier et son enregistrement dans 
> le système d’information.

> Éléments d'attention
> Le fichier mis à disposition contient uniquement les tests réalisés par les 
> laboratoires de ville. Il ne recense pas l’ensemble des tests réalisés en France.

```{r sourceUriTests}
france_official_tests_dep_url <- "https://www.data.gouv.fr/fr/datasets/r/b4ea7b4b-b7d1-4885-a099-71852291ff20"
france_official_tests_dep_codebook_url <- "https://www.data.gouv.fr/fr/datasets/r/971c5cbd-cd80-4492-b2b3-c3deff8c1f5e"
```


#### Data Structure

Dataset per departments :

```{r loadCleanFranceOfficialTestsdepCodebook, echo=FALSE}
france_official_tests_dep_codebook <- data.table::as.data.table(read.csv(file = france_official_tests_dep_codebook_url, sep = ";", header = T, stringsAsFactors = F))
#mynames <- as.character(france_official_tests_dep_codebook[1])
#setnames(france_official_tests_dep_codebook, unlist(mynames))

france_official_tests_dep_codebook %>%
  select(-Description_FR) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

We import these data and merge associate department with their Region names

```{r}
france_official_tests_dep <- data.table::as.data.table(read.csv(file = france_official_tests_dep_url, sep = ";"))
france_region_departements <- data.table::as.data.table(read.csv(file = france_region_departements_url, sep = ","))
france_official_tests_dep %>% 
  rename(
    department = dep
    , date = jour
  ) %>%
  mutate(
    date = as.Date(date)
  )-> france_official_tests_dep

france_official_tests_dep <- data.table::as.data.table(merge(
  france_official_tests_dep
  , france_region_departements
  , by.x = "department"
  , by.y = "num_dep"
))
```


#### Data per department (latest)

```{r viewTestslDataPerDep}
DT::datatable(tail(france_official_tests_dep, 200)
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```


#### Data per regions (latest)

We combine now department data per region.

```{r agregateTestsPerRegion}
france_official_tests_dep %>%
  group_by(region_name,date,clage_covid) %>%
  summarise(
    nb_test = sum(nb_test, na.rm=TRUE)
    , nb_pos = sum(nb_pos, na.rm = TRUE)
    , nb_test_h = sum(nb_test_h, na.rm = TRUE)
    , nb_pos_h = sum(nb_pos_h, na.rm = TRUE)
    , nb_test_f = sum(nb_test_f, na.rm = TRUE)
    , nb_pos_f = sum(nb_pos_f, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  data.table::as.data.table()-> france_official_tests_reg
```



```{r viewTestsDataPerRegion}
DT::datatable(france_official_tests_reg
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```


#### Data for France (latest)

We combine now for whole France.

```{r agregateTestTotal}
france_official_tests_dep %>%
  group_by(date,clage_covid) %>%
  summarise(
    nb_test = sum(nb_test, na.rm=TRUE)
    , nb_pos = sum(nb_pos, na.rm = TRUE)
    , nb_test_h = sum(nb_test_h, na.rm = TRUE)
    , nb_pos_h = sum(nb_pos_h, na.rm = TRUE)
    , nb_test_f = sum(nb_test_f, na.rm = TRUE)
    , nb_pos_f = sum(nb_pos_f, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  data.table::as.data.table()-> france_official_tests_total
```



```{r viewTestsDataPerTotal}
DT::datatable(france_official_tests_total
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```



### SI-DEP {.tabset .tabset-face .tabset-pills}

A new information system was set-up on May the 13th.

> Le nouveau système d’information de dépistage (SI-DEP), en déploiement depuis le 13 mai 2020, est une plateforme sécurisée où sont systématiquement enregistrés les résultats des laboratoires des tests (RT-PCR) réalisés par l’ensemble des laboratoires de ville et établissements hospitaliers concernant le SARS-COV2.

> La création de ce système d'information est autorisée pour une durée de 6 mois à compter de la fin de l'état d'urgence sanitaire par application du décret n° 2020-551 du 12 mai 2020 relatif aux systèmes d’information mentionnés à l’article 11 de la loi n° 2020-546 du 11 mai 2020 prorogeant l’état d’urgence sanitaire et complétant ses dispositions.

#### Data Sources

> Le présent jeu de données renseigne à l'échelle départementale et régionale :

>    le taux d'incidence quotidien et hebdomadaire par classe d'âge ;
>    le taux d’incidence standardisé quotidien et hebdomadaire ;
>    le taux d'incidence standardisé glissant.

>Le présent jeu de données renseigne à l'échelle nationale :

>    le taux d'incidence quotidien et hebdomadaire par classe d'âge et sexe ;
>    le taux d’incidence standardisé quotidien et hebdomadaire ;
>    le taux d'incidence standardisé glissant.

>Le taux d'incidence correspond au nombre de tests positifs pour 100.000 habitants. Il est calculé de la manière suivante :
>(100000 * nombre de cas positif) / Population

> Précision : Sélection de la première date avec pcr positive si plusieurs prélèvements positifs pour un même patient


> Seuls les tests biologiques des personnes pour lesquelles le département de résidence a pu être localisé sont représentés sur les cartes. Les personnes dont le département n’a pas pu être remonté dans les données SIDEP ne sont comptabilisées qu'au niveau France entière. De ce fait la somme des tests indiqués dans les départements ou régions est inférieure au nombre de tests indiqué en France.
> Le délai de remontée des tests peut excéder 9 jours dans certains cas. Les indicateurs sont ajustés quotidiennement selon la réception des résultats.


```{r sourceUriSI-DEP}
france_official_sidep_dep_url <- "https://www.data.gouv.fr/en/datasets/r/19a91d64-3cd3-42fc-9943-d635491a4d76"

france_official_sidep_dep_codebook_url <- "https://www.data.gouv.fr/en/datasets/r/a8b5931a-3aa7-4aec-a81b-8b3de628cf63"

france_official_sidep_reg_url <- "https://www.data.gouv.fr/en/datasets/r/ad09241e-52fa-4be8-8298-e5760b43cae2"

france_official_sidep_total_url <- "https://www.data.gouv.fr/en/datasets/r/57d44bd6-c9fd-424f-9a72-7834454f9e3cc"

```


#### Data per department


```{r getSIDEPdep}
france_official_sidep_dep <- data.table::as.data.table(read.csv(file = france_official_sidep_dep_url, sep = ","))

france_official_sidep_dep %>%
  mutate(date = as.Date(jour)) %>%
  mutate(cl_age90 = as.factor(cl_age90)) %>%
  select(-jour) %>%
  as.data.table()-> france_official_sidep_dep

france_official_sidep_dep <- data.table::as.data.table(merge(
  france_official_sidep_dep
  , france_region_departements
  , by.x = "dep"
  , by.y = "num_dep"
))
```


We can also compute an agregate version per regions to be compared with 
official data as it's mentioned there can be some gaps (sum of deps != reg).

```{r agregatesidepPerRegion}
france_official_sidep_dep_agg_reg <- france_official_sidep_dep[ , .(cases = sum(p)), by = .(region_name,date,cl_age90) ]

```



#### Data per regions

```{r getSIDEPdep}
france_official_sidep_reg <- data.table::as.data.table(read.csv(file = france_official_sidep_reg_url, sep = ","))

france_official_sidep_reg %>%
  mutate(date = as.Date(jour)) %>%
  mutate(cl_age90 = as.factor(cl_age90)) %>%
  select(-jour) %>%
  filter( reg != "ZZ" ) %>% # ZZ is empty data
  mutate( reg = as.numeric(reg)) %>%
  as.data.table()-> france_official_sidep_reg

france_official_sidep_reg <- data.table::as.data.table(merge(
  france_official_sidep_reg
  , regions
  , by.x = "reg"
  , by.y = "code_insee"
))
```




```{r viewsidepDataPerRegion}
DT::datatable(france_official_sidep_reg
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```


#### Data for France

We combine now region data at France level


```{r}
france_official_sidep_total <- france_official_sidep_dep[ , .(cases = sum(p)), by = .(date,cl_age90) ]
```


```{r viewsidepDataPerCountry}
DT::datatable(france_official_sidep_total
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```



# Analysis of number of cases {.tabset}

Based on John Hopkings University data and visuals and code based from ft.com by  
John Burn-Murdoch ( @jburnmurdoch )

## Confirmed cases (cum)

```{r ftConfirmed}
## Total Number of Covid-19 cases per country, log scale, from 100+ plus
## Original code from https://twitter.com/jburnmurdoch
## Stories, stats & scatterplots for @FinancialTimes  john.burn-murdoch@ft.com | #dataviz
## https://gist.githubusercontent.com/johnburnmurdoch/34bd7470dca92e470fd5f12a488923ce/raw/c7a66c8a718299ecfdb9b7c922daca5d33eb8aa0/coronavirus_cases_trajectories.R
start_case <- 100 #600

my_df <- www_cases_cum %>%
  filter(
    country != "Others" &
      #country != "Mainland China" &
      country != "Cruise Ship"
  ) %>%
  bind_rows(
    tibble(country = "Republic of Korea", date = as.Date("2020-03-11"), cases = 7755)
  ) %>%
  group_by(country) %>%
  mutate(days_since_100 = as.numeric(date-min(date[cases >= start_case]))) %>%
  ungroup() %>%
  filter(is.finite(days_since_100)) %>% 
  group_by(country) %>%
  mutate(new_cases = cases-cases[days_since_100 == 0]) %>%
  filter(sum(cases >= start_case) >= 5) %>%
  filter(cases >= start_case) %>% 
  bind_rows(
    tibble(country = "33% daily rise", days_since_100 = 0:25) %>%
      mutate(cases = start_case*1.33^days_since_100)
  ) %>%
  ungroup() %>%
  mutate(
    country = country %>% str_replace_all("( SAR)|( \\(.+)|(Republic of )", "")
  ) %>%
  filter(country %in% c(
    "France","Italy", "China", "United Kingdom"
    , "Korea, South", "Japan", "US", "Iran", "Spain", "Germany"
    , "33% daily rise" 
  ))

#my_df[ my_df$country == "France" & my_df$date == as.Date("2020-03-15"),]$cases <- 5423
#my_df[ my_df$country == "France" & my_df$date == as.Date("2020-03-15"),]$new_cases <- 5423
#today <- data.frame(list(country = "France",date = as.Date("2020-03-19"), cases = 32964, days_since_100 = 27, new_cases = 32964))
#my_df <- rbind(my_df, today)    


my_df %>%
  # filter(days_since_100 <= 10) %>%
  ggplot(aes(days_since_100, cases, col = country)) +
  geom_hline(yintercept = 100) +
  geom_vline(xintercept = 0) +
  geom_line(size = 0.8) +
  geom_point(pch = 21, size = 1) +
  scale_y_log10(
    expand = expand_scale(add = c(0,0.1))
    , breaks=c(
      100, 200, 500, 1000, 2000, 5000, 10000,
      20000, 40000, 80000, 160000, 300000, 500000, 800000,
      1000000, 1300000)
  ) +
  # scale_y_continuous(expand = expand_scale(add = c(0,100))) +
  scale_x_continuous(expand = expand_scale(add = c(0,1))) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    legend.position = "none",
    plot.margin = margin(3,15,3,3,"mm")
  ) +
  coord_cartesian(clip = "off") +
  scale_colour_manual(values = c(
    "China" = "#EB5E8D"
    , "United Kingdom" = "#ce3140"
    , "US" = "#EB5E8D"
    , "Italy" = "black"
    , "France" = "#208fce"
    , "Germany" = "#c2b7af"
    , "Hong Kong" = "#1E8FCC"
    , "Iran" = "#9dbf57"
    , "Japan" = "#208fce"
    , "Singapore" = "#1E8FCC"
    , "Korea, South" = "#208fce"
    , "Belgium" = "#c2b7af"
    , "Netherlands" = "#c2b7af"
    , "Norway" = "#c2b7af"
    , "Spain" = "#c2b7af"
    , "Sweden" = "#c2b7af"
    , "Switzerland" = "#c2b7af"
    , "33% daily rise" = "#D9CCC3"
  )) +
  geom_shadowtext(aes(label = paste0(" ",country)), hjust=0, vjust = 0, data = . %>% group_by(country) %>% top_n(1, days_since_100), bg.color = "white") +
  labs(x = "Number of days since 100th case", y = "", subtitle = "Total number of cases") -> g

g
```

```{r}
fr_dates <- my_df %>% filter( country == "France") %>% select(date)
```


The lastest availabe data are for France `r max(fr_dates$date)`.


## Deaths (cum)


```{r ftDeath}
## Total Number of Covid-19 cases per country, log scale, from 100+ plus
## Original code from https://twitter.com/jburnmurdoch
## Stories, stats & scatterplots for @FinancialTimes  john.burn-murdoch@ft.com | #dataviz
## https://gist.githubusercontent.com/johnburnmurdoch/34bd7470dca92e470fd5f12a488923ce/raw/c7a66c8a718299ecfdb9b7c922daca5d33eb8aa0/coronavirus_cases_trajectories.R


start_case <- 10 #600

my_df <- www_deaths_cum %>%
  filter(country != "Others" & country != "Mainland China" & country != "Cruise Ship") %>%
  bind_rows(
    tibble(country = "Republic of Korea", date = as.Date("2020-03-11"), cases = 7755)
  ) %>%
  group_by(country) %>%
  mutate(days_since_100 = as.numeric(date-min(date[cases >= start_case]))) %>%
  ungroup() %>%
  filter(is.finite(days_since_100)) %>% 
  group_by(country) %>%
  #mutate(new_cases = cases-cases[days_since_100 == 0]) %>%
  filter(sum(cases >= start_case) >= 5) %>%
  filter(cases >= start_case) %>% 
  bind_rows(
    tibble(country = "33% daily rise", days_since_100 = 0:33) %>%
      mutate(cases = start_case*1.33^days_since_100)
  ) %>%
  bind_rows(
    tibble(country = "25% daily rise", days_since_100 = 0:33) %>%
      mutate(cases = start_case*1.25^days_since_100)
  ) %>%
  bind_rows(
    tibble(country = "15% daily rise", days_since_100 = 0:33) %>%
      mutate(cases = start_case*1.15^days_since_100)
  ) %>%
  ungroup() %>%
  mutate(
    country = country %>% str_replace_all("( SAR)|( \\(.+)|(Republic of )", "")
  ) %>%
  filter(country %in% c(
    "France","Italy"
    , "Korea, South", "Japan", "US", "Iran", "Spain", "Germany"
    , "33% daily rise" , "25% daily rise", "15% daily rise"
  ))

# my_df[ my_df$country == "France" & my_df$date == as.Date("2020-03-15"),]$cases <- 5423
# my_df[ my_df$country == "France" & my_df$date == as.Date("2020-03-15"),]$new_cases <- 5423
#today <- data.frame(list(country = "France",date = as.Date("2020-03-27"), cases = 1995, days_since_100 = 20, new_cases = 1995))
#my_df <- rbind(my_df, today)    


my_df %>%
  # filter(days_since_100 <= 10) %>%
  ggplot(aes(days_since_100, cases, col = country)) +
  #geom_hline(yintercept = 10) +
  #geom_vline(xintercept = 0) +
  geom_line(size = 0.8) +
  geom_point(pch = 21, size = 1) +
  scale_y_log10(
    expand = expand_scale(
      add = c(0,0.1))
    , breaks=c(
      100, 200, 500, 1000, 2000, 5000, 10000,
      20000, 50000, 100000)
    
  ) +
  # scale_y_continuous(expand = expand_scale(add = c(0,100))) +
  scale_x_continuous(expand = expand_scale(add = c(0,1))) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    legend.position = "none",
    plot.margin = margin(3,15,3,3,"mm")
  ) +
  coord_cartesian(clip = "off") +
  scale_colour_manual(values = c(
    "United Kingdom" = "#ce3140"
    , "US" = "#EB5E8D"
    , "Italy" = "black"
    , "France" = "#208fce"
    , "Germany" = "#c2b7af"
    , "Hong Kong" = "#1E8FCC"
    , "Iran" = "#9dbf57"
    , "Japan" = "#208fce"
    , "Singapore" = "#1E8FCC"
    , "Korea, South" = "#208fce"
    , "Belgium" = "#c2b7af"
    , "Netherlands" = "#c2b7af"
    , "Norway" = "#c2b7af"
    , "Spain" = "#c2b7af"
    , "Sweden" = "#c2b7af"
    , "Switzerland" = "#c2b7af"
    , "33% daily rise" = "#D9CCC3"
    , "25% daily rise" = "#D9CCC3"
    , "15% daily rise" = "#D9CCC3"
  )) +
  geom_shadowtext(aes(label = paste0(" ",country)), hjust=0, vjust = 0, data = . %>% group_by(country) %>% top_n(1, days_since_100), bg.color = "white") +
  labs(x = "Number of days since 10th death", y = "", subtitle = "Total number of cases")  -> g

g
```




## Estimation of R0 {.tabset .tabset-fade .tabset-pills} 

### Analysis functions

We use the following epidemiologic parameters

```{r}
si_mean <- 5.0
si_sd <- 3.4
alt_si_mean <- 7.5
alt_si_sd <- 3.4
last_date <- "2020-06-17"
r0_date <- "2020-06-17"
```



```{r epidemicCurve}
makeEpicurve <- function(my_data, my_ncol = 3){
  my_data %>%
    select(-cases) %>%
    ggplot() +
    geom_bar(aes(x=date, y=daily_cases, fill = country), stat = "identity") +
    facet_wrap(
      facets = . ~ country
      , ncol = my_ncol
      , scales = "free_y"
      ) +
    labs(y="Incident cases", 
         title= "COVID-19 incident daily cases") +
    theme(legend.position="top")
}
```







```{r}
prefectural_earlyR <- function(df, my_country, last_date, si_mean, si_sd) {
  df %>%
    filter(date <= last_date,
           !is.na(daily_cases),
           country == my_country) %>%
    select(date, daily_cases) %>%
    uncount(daily_cases) %>%
    pull(date) -> local_case_dates
  
  local_case_dates %>%
    incidence(., last_date=last_date) -> local_cases
  
  res <- get_R(local_cases, si_mean =si_mean, si_sd = si_sd)
  res$local_case_dates <- local_case_dates
  res$city <- my_country
  res$last_date <- last_date
  res$si_mean <- si_mean
  res$si_sd <- si_sd
  return(res)
}

prefecture_plot_lambda <- function(res) {
  plot(res, "lambdas", scale = length(res$local_case_dates) + 1,
       bty="n")
  title(sub=paste("\nEstimated", expression(lambda), "for", 
                  res$region, 
                  "(assuming serial interval mean =",
                  res$si_mean, 
                  ", sd =", 
                  res$si_sd, ")"))
  abline(v = res$local_case_dates, lwd = 3, col = "grey")
  abline(v = res$last_date, col = "blue", lty = 2, lwd = 2)
  points(res$local_case_dates, seq_along(res$local_case_dates), pch = 20, cex = 3)
}

lambda_plot <- function(my_country, mydata, my_date) {
  res_obj <- prefectural_earlyR(mydata, 
                                my_country, 
                                my_date,
                                si_mean,
                                si_sd)
  
  prefecture_plot_lambda(res_obj)
}
```

```{r} 
lambda_plot(my_country = "France", mydata = france_com_cases_daily_smooth, my_date = r0_date)
```






```{r Cori_model_get_data_fr0, echo=FALSE, tidy=TRUE, message=FALSE, eval=TRUE}
plot_R <- function(my_country, start_date, last_date, mydata) {
  
  mydata <- mydata %>%
    filter(date <= last_date) %>% 
    filter(date >= start_date) %>% 
    filter(country == my_country) %>%
    filter(!is.na(daily_cases)) %>%
    select(date, daily_cases) %>%
    rename(dates=date,
           I=daily_cases)
  
  estimate_R_obj <- estimate_R(mydata,
                               method="uncertain_si",
                               config = make_config(list(
                                 mean_si = 7.5, std_mean_si = 2.0,
                                 min_mean_si = 1, max_mean_si = 8.4,
                                 std_si = 3.4, std_std_si = 1.0,
                                 min_std_si = 0.5, max_std_si = 4.0,
                                 n1 = 1000, n2 = 1000)))
  
  plot(estimate_R_obj, "R") + labs(title=paste("Instantaneous effective R - ", my_country))
}
```



### Epidemic curves

```{r plotEpiCountries}
makeEpicurve(
  my_data = www_cases_daily[ country %in% c("Italy","United Kingdom", "US", "Germany", "Sweden", "Russia", "Brazil", "Korea, South") ]
  ) / 
( makeEpicurve(
  my_data = france_com_cases_daily[ country %in% c("France") ]
  ) +
    makeEpicurve(
  my_data = france_com_cases_daily_smooth[ country %in% c("France") ]
  ) +
    makeEpicurve(
  my_data = www_cases_daily[ country %in% c("France") ]
  ) 
)
```

```{r}
plot_R(my_country = "France", start_date = r0_date, last_date = lubridate::today(), mydata = france_com_cases_daily)
```


```{r}
plot_R(my_country = "France", start_date = r0_date, last_date = lubridate::today(), mydata = france_com_cases_daily_smooth)
```



```{r}
plot_R(my_country = "Germany", start_date = r0_date, last_date = lubridate::today(), mydata = www_cases_daily)
```

```{r}
plot_R(my_country = "Italy", start_date = r0_date, last_date = lubridate::today(), mydata = www_cases_daily)
```



# Analysis of Hospital Data


Latest available data are from : `r max(france_official_hospital_dep$date)`


```{r smallMultipleHostpital}
plotSmallMultipleCovid <- function(
  my_data = NULL
  , myvariable = "death_cum"
  , colfeature = "region_name"
  , facetfeature = "dep_name"
  , ncol = 10
  , mytitle_base = "France per departments : "
){
  
  # Define the number of colors you want
  nb_cols <- length(unique(my_data[[colfeature]]))
  mycolors <- colorRampPalette(brewer.pal(8, "Dark2"))(nb_cols)
  
  my_data %>% 
    #group_by(department) %>%
    ggplot(
      aes_string(
        x="date"
        , y= myvariable
      )
    ) + 
    geom_bar(
      stat="identity"
      , aes_string(fill= colfeature)
    ) + 
    scale_fill_manual(values = mycolors) -> g
  
  if(!is.null(facetfeature)){
    g <- g + facet_wrap(
      as.formula(paste(". ~ ", facetfeature))
      , ncol = ncol
      #, scales = "free_y"
    )
  }
  g + 
    labs(
      y= "" #myvariable
      , title=paste0(mytitle_base, myvariable)
      #, subtitle="Note: differing y-axis scales"
    ) +
    theme_minimal() +
    theme(
      #legend.position = "none"
      strip.text.x = element_text(
        size=5
        , face = "bold"
        , vjust = -0.0,
        margin = margin(-0.00, 0, 0, 0, "cm")
      )
      , strip.background = element_rect(
        color ="white"
        , fill ="white"
        , size = 0.5
        #, linetype="solid"
      )
      , axis.text.x = element_text(
        angle = 90
        , size = 8
      )
      #, plot.background = element_rect(fill = '#effffe', colour = '#effffe')
    ) -> fr
  return(fr)
}
```


## France per departments {.tabset  .tabset-fade .tabset-pills}

### Currently hospitalized

```{r plotHosp}
h <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ sex == 0 ]
  , myvariable = "hospitalized_now"
  , colfeature = "region_name"
)
h
```

### Currently back home

```{r plotHome}
ho <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ sex == 0 ]
  , myvariable = "back_home_now"
  , colfeature = "region_name"
)
ho
```

### Currently in ICU

```{r plotIcu}
i <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ sex == 0 ]
  , myvariable = "icu_now"
  , colfeature = "region_name"
)
i
```

### Cumulated deaths

```{r plotDeath}
g <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ sex == 0 ]
  , myvariable = "death_cum"
  , colfeature = "region_name"
)
g
```



### Zoom : Ile de France

```{r plotIdfHosp}
idf_home <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ region_name == "Île-de-France" & sex == 0 ]
  , myvariable = "back_home_now"
  , colfeature = "department"
  , ncol = 3
)
idf_hosp <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ region_name == "Île-de-France" & sex == 0 ]
  , myvariable = "hospitalized_now"
  , colfeature = "department"
  , ncol = 3
)
idf_dead <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ region_name == "Île-de-France" & sex == 0 ]
  , myvariable = "death_cum"
  , colfeature = "department"
  , ncol = 3
)
idf_icu <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ region_name == "Île-de-France" & sex == 0 ]
  , myvariable = "icu_now"
  , colfeature = "department"
  , ncol = 3
)


( idf_home + idf_hosp ) / ( idf_icu + idf_dead) + patchwork::plot_annotation("CC BY-NC-SA datapleth.io")

```


### Zoom : 92 - Hauts-de-Seine

```{r plotId92fHosp}
idf_home <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ department == "92" & sex == 0 ]
  , myvariable = "back_home_now"
  , colfeature = "department"
  , ncol = 3
)
idf_hosp <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ department == "92" & sex == 0 ]
  , myvariable = "hospitalized_now"
  , colfeature = "department"
  , ncol = 3
)
idf_dead <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ department == "92" & sex == 0 ]
  , myvariable = "death_cum"
  , colfeature = "department"
  , ncol = 3
)
idf_icu <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ department == "92" & sex == 0 ]
  , myvariable = "icu_now"
  , colfeature = "department"
  , ncol = 3
)


( idf_home + idf_hosp ) / ( idf_icu + idf_dead) + patchwork::plot_annotation("CC BY-NC-SA datapleth.io")

```


### Zoom : 46 - Lot

```{r plotLot46Hosp}
idf_home <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ department == "46" & sex == 0 ]
  , myvariable = "back_home_now"
  , colfeature = "department"
  , ncol = 3
)
idf_hosp <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ department == "46" & sex == 0 ]
  , myvariable = "hospitalized_now"
  , colfeature = "department"
  , ncol = 3
)
idf_dead <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ department == "46" & sex == 0 ]
  , myvariable = "death_cum"
  , colfeature = "department"
  , ncol = 3
)
idf_icu <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ department == "46" & sex == 0 ]
  , myvariable = "icu_now"
  , colfeature = "department"
  , ncol = 3
)


( idf_home + idf_hosp ) / ( idf_icu + idf_dead) + patchwork::plot_annotation("CC BY-NC-SA datapleth.io")

```



## France per Regions {.tabset .tabset-fade  .tabset-pills}

### Currently hospitalized 

```{r plotHospR}
h <- plotSmallMultipleCovid(
  my_data = france_official_reg[ sex == 0 ]
  , myvariable = "hospitalized_now"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 6
  , mytitle_base = "France per regions : "
)
h
```

### Currently back home

```{r plotHomeR}
ho <- plotSmallMultipleCovid(
  my_data = france_official_reg[ sex == 0 ]
  , myvariable = "back_home_now"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 6
  , mytitle_base = "France per regions : "
)
ho
```

### Currently in ICU

```{r plotIcuR}
i <- plotSmallMultipleCovid(
  my_data = france_official_reg[ sex == 0 ]
  , myvariable = "icu_now"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 6
  , mytitle_base = "France per regions : "
)
i
```

### Cumulated deaths

```{r plotDeathR}
g <- plotSmallMultipleCovid(
  my_data = france_official_reg[ sex == 0 ]
  , myvariable = "death_cum"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 6
  , mytitle_base = "France per regions : "
)
g
```


## France Total



```{r plotHospFT}
hosp <- plotSmallMultipleCovid(
  my_data = france_official_hospital_total[ sex == 0 | TRUE ]
  , myvariable = "hospitalized_now"
  , colfeature = "sex"
  , facetfeature = "sex"
  , ncol = 3
  , mytitle_base = "France  : "
)

home <- plotSmallMultipleCovid(
  my_data = france_official_hospital_total[ sex == 0 | TRUE ]
  , myvariable = "back_home_now"
  , colfeature = "sex"
  , facetfeature = "sex"
  , ncol = 3
  , mytitle_base = "France  : "
)

icu <- plotSmallMultipleCovid(
  my_data = france_official_hospital_total[ sex == 0 | TRUE ]
  , myvariable = "icu_now"
  , colfeature = "sex"
  , facetfeature = "sex"
  , ncol = 3
  , mytitle_base = "France  : "
)


dcd <- plotSmallMultipleCovid(
  my_data = france_official_hospital_total[ sex == 0 | TRUE ]
  , myvariable = "death_cum"
  , colfeature = "sex"
  , facetfeature = "sex"
  , ncol = 3
  , mytitle_base = "France  : "
)

( hosp + home ) / ( icu + dcd) + patchwork::plot_annotation("CC BY-NC-SA datapleth.io")
```




## Comparison of cases growth {.tabset  .tabset-fade  .tabset-pills}

As the outbrek has not started at the same time in the various regions and
department of France, the best visualisation is based on growth of cumulated
cases from a given level, for instance, since the 100th death. 
These visuals and the code are inspired by the work of John Burn-Murdoch ( )@jburnmurdoch ) from the Financial Times.

```{r plotLogGrowthFunction}
library(shadowtext)
library(rlang)


plotLogGrowth <- function(
  mydata = NULL
  , myvariable = "hospitalized_now"
  , start_case = 500
  , colfeature = "department"
){
  
  ## Prepare data, each time series should start when they reach start_case
  mydata %>%
    group_by(!!as.name(colfeature)) %>%
    mutate(
      days_since_10 = as.numeric(
        date-min(
          date[!!as.name(myvariable) >= start_case]
        )
      )
    ) %>%
    ungroup() %>%
    filter(is.finite(days_since_10)) %>%
    group_by(!!as.name(colfeature)) %>%
    filter(
      sum(!!as.name(myvariable) >= start_case) >= 3 # at least 3 days visible
    ) %>%
    filter(
      !!as.name(myvariable) >= start_case
    ) -> my_df
  
  ## Compute colors 
  #nb_cols <- length(unique(my_df$department))
  nb_cols <- length(unique(my_df[[colfeature]]))
  mycolors <- colorRampPalette(brewer.pal(8, "Dark2"))(nb_cols)
  mycolors <- c(mycolors,"#DDDDDD","#DDDDDD","#DDDDDD")
  names(mycolors) = c(
    as.character(unique(my_df[[colfeature]]))
    , "x2 every 2 days"
    , "x2 every 3 days"
    , "x2 every week"
  )
  
  ## compute max x for growth rates displayed as reference
  max_x <- max(my_df$days_since_10) + 2
  
  my_df %>% 
    bind_rows(
      tibble(!!colfeature := "x2 every 2 days", days_since_10 = 0:max_x) %>%
        mutate(!!myvariable := start_case*(2^(1/2))^days_since_10)
    ) %>%
    bind_rows(
      tibble(!!colfeature := "x2 every 3 days", days_since_10 = 0:max_x) %>%
        mutate(!!myvariable := start_case*(2^(1/3))^days_since_10)
    ) %>%
    bind_rows(
      tibble(!!colfeature := "x2 every week", days_since_10 = 0:max_x) %>%
        mutate(!!myvariable := start_case*(2^(1/7))^days_since_10)
    ) %>%
    ungroup() -> my_df
  
  
  my_df %>%
    # filter(days_since_100 <= 10) %>%
    ggplot(
      aes(
        x = days_since_10
        , y = !!as.name(myvariable)
        , col = !!as.name(colfeature)
      )
    ) +
    geom_hline(yintercept = start_case) +
    geom_vline(xintercept = 0) +
    geom_line(size = 0.8) +
    geom_point(pch = 21, size = 1) +
    scale_y_log10(
      expand = expand_scale(add = c(0,0.1))
      , breaks=c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 40000, 80000)
    ) +
    # scale_y_continuous(expand = expand_scale(add = c(0,100))) +
    scale_x_continuous(
      expand = expand_scale(add = c(0,1))
      , limits = c(0, max_x + 2)
    ) +
    theme_minimal() +
    theme(
      panel.grid.minor = element_blank()
      , legend.position = "none"
      , plot.margin = margin(3,15,3,3,"mm")
      #, plot.background = element_rect(fill = '#effffe', colour = '#effffe')
    ) +
    coord_cartesian(clip = "off") +
    scale_colour_manual(values = mycolors ) +
    #facet_wrap(facets = region_name ~ ., ncol = 3) +
    geom_shadowtext(
      aes(
        #label = paste0(" ",colfeature)
        label = paste0(" ", eval(parse(text = colfeature)))
      )
      , size = 3
      , hjust=0
      , vjust = 0
      , data = . %>%
        group_by(!!as.name(colfeature)) %>%
        top_n(1, days_since_10), bg.color = "#FEFEFE"
    ) +
    labs(
      x = paste0("Number of days since ",start_case,"th case")
      , y = "" #myvariable
      , subtitle = paste0("Growth of ",myvariable," (log scale)")
    )  -> g
  
  #ggplotly(g)
  return(list(
    graph = g
    , data = my_df
  ))
}
```

### Per departments

```{r logWorstDep}
my_df <- france_official_hospital_dep[ 
  #region_name == "Île-de-France" &
  sex == 0
] 

home <- plotLogGrowth(
  mydata = my_df
  , start_case = 100
  , myvariable = "back_home_now" #death_cum"
)
hosp <- plotLogGrowth(
  mydata = my_df
  , start_case = 500
  , myvariable = "hospitalized_now" #death_cum"
)
death <- plotLogGrowth(
  mydata = my_df
  , start_case = 40
  , myvariable = "death_cum" #death_cum"
)
icu <- plotLogGrowth(
  mydata = my_df
  , start_case = 100
  , myvariable = "icu_now" #death_cum"
)
(home$graph | hosp$graph) / ( icu$graph | death$graph + gghighlight(department %in% c(75,92)) ) + 
  plot_annotation(
    title = "Covid-19 France Hospital data by departments"
    , subtitle = "by datapleth.io inspired by @jburnmurdoch"
  )
```


### Per regions

```{r logWorstReg, echo=FALSE}
my_df <- france_official_reg[ 
  #region_name == "Île-de-France" &
  sex == 0
] 

home <- plotLogGrowth(
  mydata = my_df
  , start_case = 200
  , myvariable = "back_home_now" #death_cum"
  , colfeature = "region_name"
)
hosp <- plotLogGrowth(
  mydata = my_df
  , start_case = 700
  , myvariable = "hospitalized_now" #death_cum"
  , colfeature = "region_name"
)
death <- plotLogGrowth(
  mydata = my_df
  , start_case = 100
  , myvariable = "death_cum" #death_cum"
  , colfeature = "region_name"
)
icu <- plotLogGrowth(
  mydata = my_df
  , start_case = 200
  , myvariable = "icu_now" #death_cum"
  , colfeature = "region_name"
)
(home$graph | hosp$graph) / ( icu$graph | death$graph )  + 
  plot_annotation(
    title = "Covid-19 France Hospital data by regions"
    , subtitle = "by datapleth.io inspired by @jburnmurdoch"
  )
```



### France Total

```{r logWorstFRTot, echo=FALSE}
my_df <- france_official_hospital_total[ 
  #region_name == "Île-de-France" &
  sex == 0 | TRUE
] 

home <- plotLogGrowth(
  mydata = my_df
  , start_case = 1000
  , myvariable = "back_home_now" #death_cum"
  , colfeature = "sex"
)
hosp <- plotLogGrowth(
  mydata = my_df
  , start_case = 3000
  , myvariable = "hospitalized_now" #death_cum"
  , colfeature = "sex"
)
death <- plotLogGrowth(
  mydata = my_df
  , start_case = 200
  , myvariable = "death_cum" #death_cum"
  , colfeature = "sex"
)
icu <- plotLogGrowth(
  mydata = my_df
  , start_case = 1000
  , myvariable = "icu_now" #death_cum"
  , colfeature = "sex"
)
(home$graph | hosp$graph) / ( icu$graph | death$graph )  + 
  plot_annotation(
    title = "Covid-19 France Hospital data by genre"
    , subtitle = "by datapleth.io inspired by @jburnmurdoch"
  )
```




# Analysis of Emergency Data

Latest available data are from : `r max(france_official_emergency_dep$date)`

## France per departments {.tabset  .tabset-fade .tabset-pills}

### Total ER daily visits

```{r plotERTotdep}
h <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" ]
  , myvariable = "nbre_pass_tot"
  , colfeature = "region_name" 
  , facetfeature = "dep"
)
h
```


### ER daily visits for suspicion of COVID-19

```{r plotERCoviddep}
h <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" ]
  , myvariable = "nbre_pass_corona"
  , colfeature = "region_name" 
  , facetfeature = "dep"
)
h
```



### Daily hospitalization for COVID-19

```{r plotHospCoviddep}
h <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" ]
  , myvariable = "nbre_hospit_corona"
  , colfeature = "region_name" 
  , facetfeature = "dep"
)
h
```




### Total Daily medical acts (SOS Médecin)

```{r plotSOSTotaldep}
sos <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" ]
  , myvariable = "nbre_acte_tot"
  , colfeature = "region_name" 
  , facetfeature = "dep"
)
sos
```







### Daily medical acts (SOS Médecin) for suspicion of COVID-19

```{r plotSOSCoviddep}
sos <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" ]
  , myvariable = "nbre_acte_corona"
  , colfeature = "region_name" 
  , facetfeature = "dep"
)
sos
```

## France per regions {.tabset  .tabset-fade .tabset-pills}


### Zoom : Ile de France

```{r plotIdfER}
idf_er_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Île-de-France"]
  , myvariable = "nbre_pass_tot"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France - Emergency "
)
idf_er_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Île-de-France"]
  , myvariable = "nbre_pass_corona"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France - Emergency "
)
idf_er_hosp <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Île-de-France"]
  , myvariable = "nbre_hospit_corona"
  , colfeature = "dep_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France - Emergency "
)
idf_sos_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Île-de-France"]
  , myvariable = "nbre_acte_tot"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France - SOS "
)
idf_sos_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Île-de-France"]
  , myvariable = "nbre_acte_corona"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France - SOS "
)


( idf_er_tot + idf_er_coro ) / idf_er_hosp / ( idf_sos_tot + idf_sos_coro) + patchwork::plot_annotation("CC BY-NC-SA datapleth.io")

```



### Zoom : Ile de France - 92

```{r plotIdfER92}
idf_er_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & dep == "92"]
  , myvariable = "nbre_pass_tot"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France 92 - Emergency "
)
idf_er_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" &  dep == "92"]
  , myvariable = "nbre_pass_corona"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France 92 - Emergency "
)
idf_er_hosp <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" &  dep == "92"]
  , myvariable = "nbre_hospit_corona"
  , colfeature = "dep_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France 92 - Emergency "
)
idf_sos_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" &  dep == "92"]
  , myvariable = "nbre_acte_tot"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France 92 - SOS "
)
idf_sos_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" &  dep == "92"]
  , myvariable = "nbre_acte_corona"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France 92 - SOS "
)


( idf_er_tot + idf_er_coro ) / idf_er_hosp / ( idf_sos_tot + idf_sos_coro) + patchwork::plot_annotation("CC BY-NC-SA datapleth.io")

```


### Zoom : Lot - 46

```{r plotLotER46}
idf_er_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & dep == "46"]
  , myvariable = "nbre_pass_tot"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Lot 46 - Emergency "
)
idf_er_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" &  dep == "46"]
  , myvariable = "nbre_pass_corona"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Lot 46 - Emergency "
)
idf_er_hosp <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" &  dep == "46"]
  , myvariable = "nbre_hospit_corona"
  , colfeature = "dep_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Lot 46 - Emergency "
)
idf_sos_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" &  dep == "46"]
  , myvariable = "nbre_acte_tot"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Lot 46 - SOS "
)
idf_sos_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" &  dep == "46"]
  , myvariable = "nbre_acte_corona"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Lot 46 - SOS "
)


( idf_er_tot + idf_er_coro ) / idf_er_hosp / ( idf_sos_tot + idf_sos_coro) + patchwork::plot_annotation("CC BY-NC-SA datapleth.io")

```




### Zoom : Grand Est

```{r plotGEER}
idf_er_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Grand Est"]
  , myvariable = "nbre_pass_tot"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Grand Est - Emergency "
)
idf_er_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Grand Est"]
  , myvariable = "nbre_pass_corona"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Grand Est - Emergency "
)
idf_er_hosp <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Grand Est"]
  , myvariable = "nbre_hospit_corona"
  , colfeature = "dep_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Grand Est - Emergency "
)

idf_sos_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Grand Est"]
  , myvariable = "nbre_acte_tot"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Grand Est - SOS "
)
idf_sos_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Grand Est"]
  , myvariable = "nbre_acte_corona"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Grand Est - SOS "
)

( idf_er_tot + idf_er_coro ) / idf_er_hosp / ( idf_sos_tot + idf_sos_coro) + patchwork::plot_annotation("CC BY-NC-SA datapleth.io")

```








## France Total



```{r plotErFT}
fra_er_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_total[ sursaud_cl_age_corona == "0"]
  , myvariable = "nbre_pass_tot"
  , colfeature = "fra"
  , facetfeature = "fra"
  , ncol = 3
  , mytitle_base = "France - Emergency "
)
fra_er_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_total[ sursaud_cl_age_corona == "0"]
  , myvariable = "nbre_pass_corona"
  , colfeature = "fra"
  , facetfeature = "fra"
  , ncol = 3
  , mytitle_base = "France - Emergency "
)
fra_er_hosp <- plotSmallMultipleCovid(
  my_data = france_official_emergency_total[ sursaud_cl_age_corona != "0"]
  , myvariable = "nbre_hospit_corona"
  , colfeature = "sursaud_cl_age_corona"
  , facetfeature = "fra"
  , ncol = 3
  , mytitle_base = "France - Emergency "
)

fra_sos_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_total[ sursaud_cl_age_corona != "0"]
  , myvariable = "nbre_acte_tot"
  , colfeature = "fra"
  , facetfeature = "fra"
  , ncol = 3
  , mytitle_base = "France - SOS "
)
fra_sos_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_total[ sursaud_cl_age_corona != "0"]
  , myvariable = "nbre_acte_corona"
  , colfeature = "fra"
  , facetfeature = "fra"
  , ncol = 3
  , mytitle_base = "France - SOS "
)

( fra_er_tot + fra_er_coro ) / fra_er_hosp / ( fra_sos_tot + fra_sos_coro) + patchwork::plot_annotation("CC BY-NC-SA datapleth.io")
```






# Analysis of Tests Data

Latest available data are from : `r max(france_official_tests_dep$date)`


## France per departments {.tabset  .tabset-fade .tabset-pills}

### Total daily tests

```{r plotTestsTotdep}
h <- plotSmallMultipleCovid(
  my_data = france_official_tests_dep[ clage_covid == "0" ]
  , myvariable = "nb_test"
  , colfeature = "region_name" 
  , facetfeature = "department"
)
h
```


### Total positive tests

```{r plotTestsTotdep2}
h <- plotSmallMultipleCovid(
  my_data = france_official_tests_dep[ clage_covid == "0" ]
  , myvariable = "nb_pos"
  , colfeature = "region_name" 
  , facetfeature = "department"
)
h
```


### Zoom Ile-de-France

```{r plotTestsTotdep3}
h <- plotSmallMultipleCovid(
  my_data = france_official_tests_dep[ clage_covid == "0" & region_name == "Île-de-France"]
  , myvariable = "nb_test"
  , colfeature = "department" 
  , facetfeature = "department"
  , ncol = 3
)
g <- plotSmallMultipleCovid(
  my_data = france_official_tests_dep[ clage_covid == "0" & region_name == "Île-de-France"]
  , myvariable = "nb_pos"
  , colfeature = "department" 
  , facetfeature = "department"
  , ncol = 3
)

h / g

```


## France per regions {.tabset  .tabset-fade .tabset-pills}

### Total daily tests

```{r plotTestsTotreg}
h <- plotSmallMultipleCovid(
  my_data = france_official_tests_reg[ clage_covid == "0" ]
  , myvariable = "nb_test"
  , colfeature = "region_name" 
  , facetfeature = "region_name"
)
h
```


### Total positive tests

```{r plotTestsTotreg2}
h <- plotSmallMultipleCovid(
  my_data = france_official_tests_reg[ clage_covid == "0" ]
  , myvariable = "nb_pos"
  , colfeature = "region_name" 
  , facetfeature = "region_name"
)
h
```



## France total {.tabset  .tabset-fade .tabset-pills}

### Total daily tests

```{r plotTestsTotreg3}
h <- plotSmallMultipleCovid(
  my_data = france_official_tests_total[ clage_covid == "0" ]
  , myvariable = "nb_test"
  , colfeature = "clage_covid" 
  , facetfeature = "clage_covid"
)
h
```


### Total positive tests

```{r plotTestsTotreg4}
h <- plotSmallMultipleCovid(
  my_data = france_official_tests_total[ clage_covid == "0" ]
  , myvariable = "nb_pos"
  , colfeature = "clage_covid" 
  , facetfeature = "clage_covid"
)
h
```





# Analysis of SI-DEP data

Latest available data are from : `r max(france_official_sidep_dep$date)`


## France per departments 

```{r plotsidepTotdep}
h <- plotSmallMultipleCovid(
  my_data = france_official_sidep_dep[ cl_age90 == 0 ]
  , myvariable = "p"
  , colfeature = "region_name" 
  , facetfeature = "dep"
)
h
```



### Zoom Ile-de-France

```{r plotsidepTotdep3}
h <- plotSmallMultipleCovid(
  my_data = france_official_sidep_dep[ cl_age90 == "0" & region_name == "Île-de-France"]
  , myvariable = "p"
  , colfeature = "dep" 
  , facetfeature = "dep"
  , ncol = 3
  , mytitle_base = "France SI-DEP positive tests per departements"
)
g <- plotSmallMultipleCovid(
  my_data = france_official_sidep_dep[ cl_age90 != "0" & region_name == "Île-de-France"]
  , myvariable = "p"
  , colfeature = "cl_age90" 
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "France SI-DEP positive tests per departements"
)

h / g

```


## France per regions



```{r plotsidepTotreg}
h <- plotSmallMultipleCovid(
  my_data = france_official_sidep_reg[ cl_age90 == "0" ]
  , myvariable = "cases"
  , colfeature = "region_name" 
  , facetfeature = "region_name"
  , mytitle_base = "France SI-DEP positive tests per regions"
)
h
```



## France total



```{r plotsidepTotreg3}
h1 <- plotSmallMultipleCovid(
  my_data = france_official_sidep_total[ cl_age90 != "0" ]
  , myvariable = "cases"
  , colfeature = "cl_age90" 
  , facetfeature = "cl_age90"
  , mytitle_base = "France SI-DEP positive tests"
)
h2 <- plotSmallMultipleCovid(
  my_data = france_official_sidep_total[ cl_age90 == "0" ]
  , myvariable = "cases"
  , colfeature = "cl_age90" 
  , facetfeature = "cl_age90"
  , mytitle_base = "France SI-DEP positive tests"
)

h1 / h2
```



