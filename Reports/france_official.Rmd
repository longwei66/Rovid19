---
title: "Analysing COVID-19 (2019-nCoV) outbreak in France"
draft: true
description: "A further exploration of COVID-19 incidence data using R tools and packages."
categories:
  - R
  - "COVID-19"
author:
  - name: Barthélémy Longueville for datapleth.io
creative_commons: CC BY-SA
twitter:
  creator: "@datapleth"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 3
    self_contained: true
    number_sections: true
---

```{r loadLibs, include=FALSE}
library(tidyverse)
library(data.table)
library(kableExtra)
library(DT)
library(RColorBrewer)
library(plotly)
library(patchwork)
library(shadowtext)

knitr::opts_chunk$set(fig.width=9, fig.height=9, echo=FALSE, warning = FALSE, message = FALSE) 
```




# Introduction & Objectives

This documents provides an analysis of Covid-19 outbreak in France based on 
offical data, as well as some comparison with Italy.

Situation will be reviewed at country level, regional level and department
level.

Visualisation and some elements of code are inspired by the best reference we
found during this period :

- John Burn-Murdoch ( @jburnmurdoch ) who is a senior dataviz journalist at ft.com (see [his work here](https://www.ft.com/coronavirus-latest))
- Tim Churches with scientist at South Western Sydney Clinical School, UNSW 
Medicine & Ingham Institute of Applied Medical Research, Liverpool, Sydney, 
Australia. ( [link](https://swscs.med.unsw.edu.au) and his 
work [here](https://timchurches.github.io/blog/))

This report is published under creative common CC BY-SA, and code should be
GPL 3.0


# France in the word {.tabset}

Based on John Hopkings University data and visuals and code based from ft.com by  
John Burn-Murdoch ( @jburnmurdoch )

## Confirmed cases (cum)

```{r ftConfirmed}
## Total Number of Covid-19 cases per country, log scale, from 100+ plus
## Original code from https://twitter.com/jburnmurdoch
## Stories, stats & scatterplots for @FinancialTimes  john.burn-murdoch@ft.com | #dataviz
## https://gist.githubusercontent.com/johnburnmurdoch/34bd7470dca92e470fd5f12a488923ce/raw/c7a66c8a718299ecfdb9b7c922daca5d33eb8aa0/coronavirus_cases_trajectories.R
start_case <- 100 #600

my_df <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv") %>%
  gather(date, cases, 5:ncol(.)) %>%
  mutate(date = as.Date(date, "%m/%d/%y")) %>%
  group_by(country = `Country/Region`, date) %>%
  summarise(cases = sum(cases)) %>%
  filter(
    country != "Others" &
      #country != "Mainland China" &
      country != "Cruise Ship"
  ) %>%
  bind_rows(
    tibble(country = "Republic of Korea", date = as.Date("2020-03-11"), cases = 7755)
  ) %>%
  group_by(country) %>%
  mutate(days_since_100 = as.numeric(date-min(date[cases >= start_case]))) %>%
  ungroup() %>%
  filter(is.finite(days_since_100)) %>% 
  group_by(country) %>%
  mutate(new_cases = cases-cases[days_since_100 == 0]) %>%
  filter(sum(cases >= start_case) >= 5) %>%
  filter(cases >= start_case) %>% 
  bind_rows(
    tibble(country = "33% daily rise", days_since_100 = 0:25) %>%
      mutate(cases = start_case*1.33^days_since_100)
  ) %>%
  ungroup() %>%
  mutate(
    country = country %>% str_replace_all("( SAR)|( \\(.+)|(Republic of )", "")
  ) %>%
  filter(country %in% c(
    "France","Italy", "China", "United Kingdom"
    , "Korea, South", "Japan", "US", "Iran", "Spain", "Germany"
    , "33% daily rise" 
  ))

#my_df[ my_df$country == "France" & my_df$date == as.Date("2020-03-15"),]$cases <- 5423
#my_df[ my_df$country == "France" & my_df$date == as.Date("2020-03-15"),]$new_cases <- 5423
#today <- data.frame(list(country = "France",date = as.Date("2020-03-19"), cases = 32964, days_since_100 = 27, new_cases = 32964))
#my_df <- rbind(my_df, today)    


my_df %>%
  # filter(days_since_100 <= 10) %>%
  ggplot(aes(days_since_100, cases, col = country)) +
  geom_hline(yintercept = 100) +
  geom_vline(xintercept = 0) +
  geom_line(size = 0.8) +
  geom_point(pch = 21, size = 1) +
  scale_y_log10(
    expand = expand_scale(add = c(0,0.1))
    , breaks=c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 40000, 80000, 160000)
  ) +
  # scale_y_continuous(expand = expand_scale(add = c(0,100))) +
  scale_x_continuous(expand = expand_scale(add = c(0,1))) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    legend.position = "none",
    plot.margin = margin(3,15,3,3,"mm")
  ) +
  coord_cartesian(clip = "off") +
  scale_colour_manual(values = c(
    "China" = "#EB5E8D"
    , "United Kingdom" = "#ce3140"
    , "US" = "#EB5E8D"
    , "Italy" = "black"
    , "France" = "#208fce"
    , "Germany" = "#c2b7af"
    , "Hong Kong" = "#1E8FCC"
    , "Iran" = "#9dbf57"
    , "Japan" = "#208fce"
    , "Singapore" = "#1E8FCC"
    , "Korea, South" = "#208fce"
    , "Belgium" = "#c2b7af"
    , "Netherlands" = "#c2b7af"
    , "Norway" = "#c2b7af"
    , "Spain" = "#c2b7af"
    , "Sweden" = "#c2b7af"
    , "Switzerland" = "#c2b7af"
    , "33% daily rise" = "#D9CCC3"
  )) +
  geom_shadowtext(aes(label = paste0(" ",country)), hjust=0, vjust = 0, data = . %>% group_by(country) %>% top_n(1, days_since_100), bg.color = "white") +
  labs(x = "Number of days since 100th case", y = "", subtitle = "Total number of cases") -> g

g
```

```{r}
fr_dates <- my_df %>% filter( country == "France") %>% select(date)
```


The lastest availabe data are for France `r max(fr_dates$date)`.


## Deaths (cum)


```{r ftDeath}
## Total Number of Covid-19 cases per country, log scale, from 100+ plus
## Original code from https://twitter.com/jburnmurdoch
## Stories, stats & scatterplots for @FinancialTimes  john.burn-murdoch@ft.com | #dataviz
## https://gist.githubusercontent.com/johnburnmurdoch/34bd7470dca92e470fd5f12a488923ce/raw/c7a66c8a718299ecfdb9b7c922daca5d33eb8aa0/coronavirus_cases_trajectories.R


start_case <- 10 #600

my_df <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv") %>%
  gather(date, cases, 5:ncol(.)) %>%
  mutate(date = as.Date(date, "%m/%d/%y")) %>%
  group_by(country = `Country/Region`, date) %>%
  summarise(cases = sum(cases)) %>%
  filter(country != "Others" & country != "Mainland China" & country != "Cruise Ship") %>%
  bind_rows(
    tibble(country = "Republic of Korea", date = as.Date("2020-03-11"), cases = 7755)
  ) %>%
  group_by(country) %>%
  mutate(days_since_100 = as.numeric(date-min(date[cases >= start_case]))) %>%
  ungroup() %>%
  filter(is.finite(days_since_100)) %>% 
  group_by(country) %>%
  #mutate(new_cases = cases-cases[days_since_100 == 0]) %>%
  filter(sum(cases >= start_case) >= 5) %>%
  filter(cases >= start_case) %>% 
  bind_rows(
    tibble(country = "33% daily rise", days_since_100 = 0:33) %>%
      mutate(cases = start_case*1.33^days_since_100)
  ) %>%
  bind_rows(
    tibble(country = "25% daily rise", days_since_100 = 0:33) %>%
      mutate(cases = start_case*1.25^days_since_100)
  ) %>%
  bind_rows(
    tibble(country = "15% daily rise", days_since_100 = 0:33) %>%
      mutate(cases = start_case*1.15^days_since_100)
  ) %>%
  ungroup() %>%
  mutate(
    country = country %>% str_replace_all("( SAR)|( \\(.+)|(Republic of )", "")
  ) %>%
  filter(country %in% c(
    "France","Italy"
    , "Korea, South", "Japan", "US", "Iran", "Spain", "Germany"
    , "33% daily rise" , "25% daily rise", "15% daily rise"
  ))

# my_df[ my_df$country == "France" & my_df$date == as.Date("2020-03-15"),]$cases <- 5423
# my_df[ my_df$country == "France" & my_df$date == as.Date("2020-03-15"),]$new_cases <- 5423
#today <- data.frame(list(country = "France",date = as.Date("2020-03-27"), cases = 1995, days_since_100 = 20, new_cases = 1995))
#my_df <- rbind(my_df, today)    


my_df %>%
  # filter(days_since_100 <= 10) %>%
  ggplot(aes(days_since_100, cases, col = country)) +
  #geom_hline(yintercept = 10) +
  #geom_vline(xintercept = 0) +
  geom_line(size = 0.8) +
  geom_point(pch = 21, size = 1) +
  scale_y_log10(expand = expand_scale(add = c(0,0.1)), breaks=c(100, 200, 500, 1000, 2000, 5000, 10000)) +
  # scale_y_continuous(expand = expand_scale(add = c(0,100))) +
  scale_x_continuous(expand = expand_scale(add = c(0,1))) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank(),
    legend.position = "none",
    plot.margin = margin(3,15,3,3,"mm")
  ) +
  coord_cartesian(clip = "off") +
  scale_colour_manual(values = c(
    "United Kingdom" = "#ce3140"
    , "US" = "#EB5E8D"
    , "Italy" = "black"
    , "France" = "#208fce"
    , "Germany" = "#c2b7af"
    , "Hong Kong" = "#1E8FCC"
    , "Iran" = "#9dbf57"
    , "Japan" = "#208fce"
    , "Singapore" = "#1E8FCC"
    , "Korea, South" = "#208fce"
    , "Belgium" = "#c2b7af"
    , "Netherlands" = "#c2b7af"
    , "Norway" = "#c2b7af"
    , "Spain" = "#c2b7af"
    , "Sweden" = "#c2b7af"
    , "Switzerland" = "#c2b7af"
    , "33% daily rise" = "#D9CCC3"
    , "25% daily rise" = "#D9CCC3"
    , "15% daily rise" = "#D9CCC3"
  )) +
  geom_shadowtext(aes(label = paste0(" ",country)), hjust=0, vjust = 0, data = . %>% group_by(country) %>% top_n(1, days_since_100), bg.color = "white") +
  labs(x = "Number of days since 10th death", y = "", subtitle = "Total number of cases")  -> g

g
```









# France Official Data

## Hospital data {.tabset .tabset-fade .tabset-pills} 

### Data Sources

Since Friday march 27th, French government is publishing data for hospital and
health network.

From [data.gouv.fr](https://www.data.gouv.fr/fr/datasets/donnees-hospitalieres-relatives-a-lepidemie-de-covid-19/)

> Le présent jeu de données renseigne sur la situation hospitalières concernant
> l'épidémie de COVID-19 :

> Deux fichiers sont proposés :

> 1/ Les données hospitalières quotidiennes relatives à l'épidémie du COVID-19 par 
> département et sexe du patient : nombre de patients hospitalisés, nombre de 
> personnes actuellement en réanimation ou soins intensifs, nombre cumulé de 
> personnes retournées à domicile, nombre cumulé de personnes décédées.

> 2/ Les données quotidiennes relatives aux établissements hospitaliers par
> département : nombre cumulé de services ayant déclaré au moins un cas.
> Pour chacun des fichiers, une fiche de métadonnées est proposée.

> Attention : certains fichiers peuvent également comporter des anomalies. 
> N'hésitez pas à les signaler en commentaire. Santé publique France 
> communiquera les anomalies aux services métiers.


```{r sourceUriHosp}
france_official_hospital_dep_url <- "https://www.data.gouv.fr/fr/datasets/r/63352e38-d353-4b54-bfd1-f1b3ee1cabd7"
france_official_hospital_dep_codebook_url <- "https://www.data.gouv.fr/fr/datasets/r/3f0f1885-25f4-4102-bbab-edec5a58e34a"

france_region_departements_url <- "https://www.data.gouv.fr/en/datasets/r/987227fb-dcb2-429e-96af-8979f97c9c84"
```



### Data Struture

```{r loadCleanFranceOfficialCodebook, echo=FALSE}
france_official_hospital_dep_codebook <- data.table::as.data.table(read.csv(file = france_official_hospital_dep_codebook_url, sep = ";"))

france_official_hospital_dep_codebook %>%
  rename(Feature = Colonne) %>%
  mutate(Feature = c( "departement", "sex", "date", "hospitalized_now", "icu_now", "returned_home_now", "death_cum")) -> france_official_hospital_dep_codebook

france_official_hospital_dep_codebook %>%
  select(-Description_FR) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

We import these data and merge associate department with their Region names

```{r}
france_official_hospital_dep <- data.table::as.data.table(read.csv(file = france_official_hospital_dep_url, sep = ";"))
france_region_departements <- data.table::as.data.table(read.csv(file = france_region_departements_url, sep = ","))
france_official_hospital_dep %>% 
  rename(
    department = dep
    , sex = sexe
    , date = jour
    , hospitalized_now = hosp
    , icu_now = rea
    , back_home_now = rad
    , death_cum = dc
  ) %>%
  mutate(
    date = as.Date(date)
  )-> france_official_hospital_dep

france_official_hospital_dep <- data.table::as.data.table(merge(
  france_official_hospital_dep
  , france_region_departements
  , by.x = "department"
  , by.y = "num_dep"
))
```



### Data per department

```{r viewHospitalDataPerDep}
DT::datatable(france_official_hospital_dep
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```

### Data per regions

We combine now department data per region.

```{r agregateHospPerRegion}
france_official_hospital_dep %>%
  group_by(region_name,sex,date) %>%
  summarise(
    hospitalized_now = sum(hospitalized_now, na.rm=TRUE)
    , icu_now = sum(icu_now, na.rm = TRUE)
    , back_home_now = sum(back_home_now, na.rm = TRUE)
    , death_cum = sum(death_cum, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  data.table::as.data.table()-> france_official_reg
```



```{r viewHospitalDataPerRegion}
DT::datatable(france_official_reg
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```

### Data for France (Total)

We use department data to aggregate results at Country level

```{r agregateHospTotal}
france_official_hospital_dep %>%
  group_by(sex,date) %>%
  summarise(
    hospitalized_now = sum(hospitalized_now, na.rm=TRUE)
    , icu_now = sum(icu_now, na.rm = TRUE)
    , back_home_now = sum(back_home_now, na.rm = TRUE)
    , death_cum = sum(death_cum, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate( sex = as.factor(sex)) %>%
  data.table::as.data.table()-> france_official_hospital_total
```


```{r viewHospitalDataTotal}
DT::datatable(france_official_hospital_total
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```


## Emergency Data {.tabset .tabset-fade .tabset-pills}

This covers emergency GP ( SOS Medecins ) & Hospital Emergency Wards, per region and per department.

### Data Sources


Since Friday march 27th, French government is publishing data for hospital and
health network.

From [data.gouv.fr](https://www.data.gouv.fr/fr/datasets/donnees-des-urgences-hospitalieres-et-de-sos-medecins-relatives-a-lepidemie-de-covid-19/#_)


> Description du jeu de données
> Quatre fichiers sont proposés :

> Les données quotidiennes de SOS médecins et des urgences hospitalières par
> département, sexe et tranche d’âge des patients : nombre de passages aux
> urgences pour suspicion de COVID-19, nombre total de passages aux urgences,
> nombre d’hospitalisations parmi les passages aux urgences pour suspicion de
> COVID-19, nombre total d’actes médicaux SOS Médecins pour suspicion de
> COVID-19, nombre d’actes médicaux SOS Médecins.


> Les données quotidiennes de SOS médecins et des urgences hospitalières par
> région, sexe et tranches d’âge des patients : nombre de passages aux
> urgences pour suspicion de COVID-19, nombre total de passages aux urgences,
> nombre d’hospitalisations parmi les passages aux urgences pour suspicion de
> COVID-19, nombre d’actes médicaux SOS Médecins pour suspicion de COVID-19,
> nombre d’actes médicaux SOS Médecins total. Le code région correspond au
> code INSEE publié par l’INSEE sur www.data.gouv.fr.

```{r sourceUriEmergency}
france_official_emergency_dep_url <- "https://www.data.gouv.fr/fr/datasets/r/eceb9fb4-3ebc-4da3-828d-f5939712600a"
france_official_emergency_dep_codebook_url <- "https://www.data.gouv.fr/fr/datasets/r/2265d880-5260-4b34-8827-b3d76180032e"

france_official_emergency_reg_url <- "https://www.data.gouv.fr/fr/datasets/r/d2af5160-a21d-47b7-8f30-3c20dade63b1"
france_official_emergency_reg_codebook_url <- "https://www.data.gouv.fr/fr/datasets/r/02c99d99-96a0-4953-8e30-04fd660530f6"

france_official_emergency_total_url <- "https://www.data.gouv.fr/fr/datasets/r/219427ba-7e90-4eb1-9ac7-4de2e7e2112c"
france_official_emergency_total_codebook_url <- "https://www.data.gouv.fr/fr/datasets/r/0289e4fe-bb67-42b9-a320-cd22c98d82c3"



france_age_categories_url <- "https://www.data.gouv.fr/fr/datasets/r/cbed61a8-64e8-4c8c-8e97-65d3a31a99b6"

france_regions_url <- "https://data.opendatasoft.com/explore/dataset/contours-geographiques-tres-simplifies-des-regions-2019@ofgl-opendatamef/download/?format=csv&timezone=Europe/Berlin&use_labels_for_header=true&csv_separator=%3B"

```


### Data Structure

Dataset per departments :

```{r loadCleanFranceOfficialERdepCodebook, echo=FALSE}
france_official_emergency_dep_codebook <- data.table::as.data.table(read.csv(file = france_official_emergency_dep_codebook_url, sep = ";", header = T, stringsAsFactors = F))
mynames <- as.character(france_official_emergency_dep_codebook[1])
setnames(france_official_emergency_dep_codebook, unlist(mynames))

france_official_emergency_dep_codebook %>%
  select(-Description_FR) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Dataset per Regions :

```{r loadCleanFranceOfficialERregCodebook, echo=FALSE}
france_official_emergency_reg_codebook <- data.table::as.data.table(read.csv(file = france_official_emergency_reg_codebook_url, sep = ";", header = T, stringsAsFactors = F))
mynames <- as.character(france_official_emergency_reg_codebook[1])
setnames(france_official_emergency_reg_codebook, unlist(mynames))

france_official_emergency_reg_codebook %>%
  select(-Description_FR) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

Age categories

```{r getAgeCategories}
france_age_categories <- data.table::as.data.table(read.csv(file = france_age_categories_url, sep = ";", header = T, stringsAsFactors = F))
names(france_age_categories) <- c("category_code", "category_description")

france_age_categories %>%
  #select(-Description_FR) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

```




### Data per department


```{r}
france_official_emergency_dep <- data.table::as.data.table(read.csv(file = france_official_emergency_dep_url, sep = ","))
france_official_emergency_dep %>%
  mutate(date = as.Date(date_de_passage)) %>%
  as.data.table()-> france_official_emergency_dep

france_official_emergency_dep <- data.table::as.data.table(merge(
  france_official_emergency_dep
  , france_region_departements
  , by.x = "dep"
  , by.y = "num_dep"
))
```



```{r viewHospitalDataPerERDep}
DT::datatable(tail(france_official_emergency_dep,100)
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```


### Data per regions


```{r}
france_official_emergency_reg <- data.table::as.data.table(read.csv(file = france_official_emergency_reg_url, sep = ","))


regions <- as.data.table(read.csv(
  file= france_regions_url
  , sep = ";"))
regions <- regions %>% 
  mutate( code_insee = Code.INSEE, region_name = Nom.région) %>%
  select(code_insee, region_name)

france_official_emergency_reg <- merge(
  x =france_official_emergency_reg
  , y = regions
  , by.x = "reg"
  , by.y = "code_insee")
```



```{r viewHospitalDataERPerReg}
DT::datatable(tail(france_official_emergency_reg,100)
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```



### Data for France


```{r}
france_official_emergency_total <- read.csv(file = france_official_emergency_total_url, sep = ",", stringsAsFactors = TRUE) %>%
  mutate(
    date = as.Date(date_de_passage)
  ) %>%
  data.table::as.data.table()
```



```{r viewHospitalDataERTotal}
DT::datatable(tail(france_official_emergency_total,100)
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```




## Covid positive cases {.tabset .tabset-face .tabset-pills}

### Data sources

```{r}
opencovid_fr_url <- "https://raw.githubusercontent.com/opencovid19-fr/data/master/dist/chiffres-cles.csv"
```


Complementary data with cumulative number of cases. This information
is not present in hospital data.

```{r}
opencovid_fr <- read.csv(opencovid_fr_url)
```



### Data Structure

### Data per department

### Data per regions



# Analysis of Hospital Data


Latest available data are from : `r max(france_official_hospital_dep$date)`


```{r smallMultipleHostpital}
plotSmallMultipleCovid <- function(
  my_data = NULL
  , myvariable = "death_cum"
  , colfeature = "region_name"
  , facetfeature = "dep_name"
  , ncol = 10
  , mytitle_base = "France per departments : "
){
  
  # Define the number of colors you want
  nb_cols <- length(unique(my_data[[colfeature]]))
  mycolors <- colorRampPalette(brewer.pal(8, "Dark2"))(nb_cols)
  
  my_data %>% 
    #group_by(department) %>%
    ggplot(
      aes_string(
        x="date"
        , y= myvariable
      )
    ) + 
    geom_bar(
      stat="identity"
      , aes_string(fill= colfeature)
    ) + 
    scale_fill_manual(values = mycolors) -> g
  
  if(!is.null(facetfeature)){
    g <- g + facet_wrap(
      as.formula(paste(". ~ ", facetfeature))
      , ncol = ncol
      #, scales = "free_y"
    )
  }
  g + 
    labs(
      y= "" #myvariable
      , title=paste0(mytitle_base, myvariable)
      #, subtitle="Note: differing y-axis scales"
    ) +
    theme_minimal() +
    theme(
      #legend.position = "none"
      strip.text.x = element_text(
        size=5
        , face = "bold"
        , vjust = -0.0,
        margin = margin(-0.00, 0, 0, 0, "cm")
      )
      , strip.background = element_rect(
        color ="white"
        , fill ="white"
        , size = 0.5
        #, linetype="solid"
      )
      , axis.text.x = element_text(
        angle = 90
        , size = 8
      )
      #, plot.background = element_rect(fill = '#effffe', colour = '#effffe')
    ) -> fr
  return(fr)
}
```


## France per departments {.tabset  .tabset-fade .tabset-pills}

### Currently hospitalized

```{r plotHosp}
h <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ sex == 0 ]
  , myvariable = "hospitalized_now"
  , colfeature = "region_name"
)
h
```

### Currently back home

```{r plotHome}
ho <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ sex == 0 ]
  , myvariable = "back_home_now"
  , colfeature = "region_name"
)
ho
```

### Currently in ICU

```{r plotIcu}
i <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ sex == 0 ]
  , myvariable = "icu_now"
  , colfeature = "region_name"
)
i
```

### Cumulated deaths

```{r plotDeath}
g <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ sex == 0 ]
  , myvariable = "death_cum"
  , colfeature = "region_name"
)
g
```



### Zoom : Ile de France

```{r plotIdfHosp}
idf_home <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ region_name == "Île-de-France" & sex == 0 ]
  , myvariable = "back_home_now"
  , colfeature = "department"
  , ncol = 3
)
idf_hosp <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ region_name == "Île-de-France" & sex == 0 ]
  , myvariable = "hospitalized_now"
  , colfeature = "department"
  , ncol = 3
)
idf_dead <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ region_name == "Île-de-France" & sex == 0 ]
  , myvariable = "death_cum"
  , colfeature = "department"
  , ncol = 3
)
idf_icu <- plotSmallMultipleCovid(
  my_data = france_official_hospital_dep[ region_name == "Île-de-France" & sex == 0 ]
  , myvariable = "icu_now"
  , colfeature = "department"
  , ncol = 3
)


( idf_home + idf_hosp ) / ( idf_icu + idf_dead)

```




## France per Regions {.tabset .tabset-fade  .tabset-pills}

### Currently hospitalized 

```{r plotHospR}
h <- plotSmallMultipleCovid(
  my_data = france_official_reg[ sex == 0 ]
  , myvariable = "hospitalized_now"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 6
  , mytitle_base = "France per regions : "
)
h
```

### Currently back home

```{r plotHomeR}
ho <- plotSmallMultipleCovid(
  my_data = france_official_reg[ sex == 0 ]
  , myvariable = "back_home_now"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 6
  , mytitle_base = "France per regions : "
)
ho
```

### Currently in ICU

```{r plotIcuR}
i <- plotSmallMultipleCovid(
  my_data = france_official_reg[ sex == 0 ]
  , myvariable = "icu_now"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 6
  , mytitle_base = "France per regions : "
)
i
```

### Cumulated deaths

```{r plotDeathR}
g <- plotSmallMultipleCovid(
  my_data = france_official_reg[ sex == 0 ]
  , myvariable = "death_cum"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 6
  , mytitle_base = "France per regions : "
)
g
```


## France Total



```{r plotHospFT}
hosp <- plotSmallMultipleCovid(
  my_data = france_official_hospital_total[ sex == 0 | TRUE ]
  , myvariable = "hospitalized_now"
  , colfeature = "sex"
  , facetfeature = "sex"
  , ncol = 3
  , mytitle_base = "France  : "
)

home <- plotSmallMultipleCovid(
  my_data = france_official_hospital_total[ sex == 0 | TRUE ]
  , myvariable = "back_home_now"
  , colfeature = "sex"
  , facetfeature = "sex"
  , ncol = 3
  , mytitle_base = "France  : "
)

icu <- plotSmallMultipleCovid(
  my_data = france_official_hospital_total[ sex == 0 | TRUE ]
  , myvariable = "icu_now"
  , colfeature = "sex"
  , facetfeature = "sex"
  , ncol = 3
  , mytitle_base = "France  : "
)


dcd <- plotSmallMultipleCovid(
  my_data = france_official_hospital_total[ sex == 0 ]
  , myvariable = "death_cum"
  , colfeature = "sex"
  , facetfeature = "sex"
  , ncol = 3
  , mytitle_base = "France  : "
)

( hosp + home ) / ( icu + dcd)
```




## Comparison of cases growth {.tabset  .tabset-fade  .tabset-pills}

As the outbrek has not started at the same time in the various regions and
department of France, the best visualisation is based on growth of cumulated
cases from a given level, for instance, since the 100th death. 
These visuals and the code are inspired by the work of John Burn-Murdoch ( )@jburnmurdoch ) from the Financial Times.

```{r plotLogGrowthFunction}
library(shadowtext)
library(rlang)


plotLogGrowth <- function(
  mydata = NULL
  , myvariable = "hospitalized_now"
  , start_case = 500
  , colfeature = "department"
){
  
  ## Prepare data, each time series should start when they reach start_case
  mydata %>%
    group_by(!!as.name(colfeature)) %>%
    mutate(
      days_since_10 = as.numeric(
        date-min(
          date[!!as.name(myvariable) >= start_case]
        )
      )
    ) %>%
    ungroup() %>%
    filter(is.finite(days_since_10)) %>%
    group_by(!!as.name(colfeature)) %>%
    filter(
      sum(!!as.name(myvariable) >= start_case) >= 3 # at least 3 days visible
    ) %>%
    filter(
      !!as.name(myvariable) >= start_case
    ) -> my_df
  
  ## Compute colors 
  #nb_cols <- length(unique(my_df$department))
  nb_cols <- length(unique(my_df[[colfeature]]))
  mycolors <- colorRampPalette(brewer.pal(8, "Dark2"))(nb_cols)
  mycolors <- c(mycolors,"#DDDDDD","#DDDDDD","#DDDDDD")
  names(mycolors) = c(
    as.character(unique(my_df[[colfeature]]))
    , "x2 every 2 days"
    , "x2 every 3 days"
    , "x2 every week"
    )
  
  ## compute max x for growth rates displayed as reference
  max_x <- max(my_df$days_since_10) + 2
  
  my_df %>% 
    bind_rows(
      tibble(!!colfeature := "x2 every 2 days", days_since_10 = 0:max_x) %>%
        mutate(!!myvariable := start_case*(2^(1/2))^days_since_10)
    ) %>%
    bind_rows(
      tibble(!!colfeature := "x2 every 3 days", days_since_10 = 0:max_x) %>%
        mutate(!!myvariable := start_case*(2^(1/3))^days_since_10)
    ) %>%
    bind_rows(
      tibble(!!colfeature := "x2 every week", days_since_10 = 0:max_x) %>%
        mutate(!!myvariable := start_case*(2^(1/7))^days_since_10)
    ) %>%
    ungroup() -> my_df
  
  
  my_df %>%
    # filter(days_since_100 <= 10) %>%
    ggplot(
      aes(
        x = days_since_10
        , y = !!as.name(myvariable)
        , col = !!as.name(colfeature)
      )
    ) +
    geom_hline(yintercept = start_case) +
    geom_vline(xintercept = 0) +
    geom_line(size = 0.8) +
    geom_point(pch = 21, size = 1) +
    scale_y_log10(
      expand = expand_scale(add = c(0,0.1))
      , breaks=c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 40000, 80000)
    ) +
    # scale_y_continuous(expand = expand_scale(add = c(0,100))) +
    scale_x_continuous(
      expand = expand_scale(add = c(0,1))
      , limits = c(0, max_x + 2)
    ) +
    theme_minimal() +
    theme(
      panel.grid.minor = element_blank()
      , legend.position = "none"
      , plot.margin = margin(3,15,3,3,"mm")
      #, plot.background = element_rect(fill = '#effffe', colour = '#effffe')
    ) +
    coord_cartesian(clip = "off") +
    scale_colour_manual(values = mycolors ) +
    #facet_wrap(facets = region_name ~ ., ncol = 3) +
    geom_shadowtext(
      aes(
        #label = paste0(" ",colfeature)
        label = paste0(" ", eval(parse(text = colfeature)))
      )
      , size = 3
      , hjust=0
      , vjust = 0
      , data = . %>%
        group_by(!!as.name(colfeature)) %>%
        top_n(1, days_since_10), bg.color = "#FEFEFE"
    ) +
    labs(
      x = paste0("Number of days since ",start_case,"th case")
      , y = "" #myvariable
      , subtitle = paste0("Growth of ",myvariable," (log scale)")
    )  -> g
  
  #ggplotly(g)
  return(list(
    graph = g
    , data = my_df
  ))
}
```

### Per departments

```{r logWorstDep}
my_df <- france_official_hospital_dep[ 
  #region_name == "Île-de-France" &
  sex == 0
  ] 

home <- plotLogGrowth(
  mydata = my_df
  , start_case = 100
  , myvariable = "back_home_now" #death_cum"
)
hosp <- plotLogGrowth(
  mydata = my_df
  , start_case = 500
  , myvariable = "hospitalized_now" #death_cum"
)
death <- plotLogGrowth(
  mydata = my_df
  , start_case = 40
  , myvariable = "death_cum" #death_cum"
)
icu <- plotLogGrowth(
  mydata = my_df
  , start_case = 100
  , myvariable = "icu_now" #death_cum"
)
(home$graph | hosp$graph) / ( icu$graph | death$graph ) + 
  plot_annotation(
    title = "Covid-19 France Hospital data by departments"
    , subtitle = "by datapleth.io inspired by @jburnmurdoch"
    )
```


### Per regions

```{r logWorstReg, echo=FALSE}
my_df <- france_official_reg[ 
  #region_name == "Île-de-France" &
  sex == 0
  ] 

home <- plotLogGrowth(
  mydata = my_df
  , start_case = 200
  , myvariable = "back_home_now" #death_cum"
  , colfeature = "region_name"
)
hosp <- plotLogGrowth(
  mydata = my_df
  , start_case = 700
  , myvariable = "hospitalized_now" #death_cum"
  , colfeature = "region_name"
)
death <- plotLogGrowth(
  mydata = my_df
  , start_case = 100
  , myvariable = "death_cum" #death_cum"
  , colfeature = "region_name"
)
icu <- plotLogGrowth(
  mydata = my_df
  , start_case = 200
  , myvariable = "icu_now" #death_cum"
  , colfeature = "region_name"
)
(home$graph | hosp$graph) / ( icu$graph | death$graph )  + 
  plot_annotation(
    title = "Covid-19 France Hospital data by regions"
    , subtitle = "by datapleth.io inspired by @jburnmurdoch"
    )
```



### France Total

```{r logWorstFRTot, echo=FALSE}
my_df <- france_official_hospital_total[ 
  #region_name == "Île-de-France" &
  sex == 0 | TRUE
  ] 

home <- plotLogGrowth(
  mydata = my_df
  , start_case = 1000
  , myvariable = "back_home_now" #death_cum"
  , colfeature = "sex"
)
hosp <- plotLogGrowth(
  mydata = my_df
  , start_case = 3000
  , myvariable = "hospitalized_now" #death_cum"
  , colfeature = "sex"
)
death <- plotLogGrowth(
  mydata = my_df
  , start_case = 200
  , myvariable = "death_cum" #death_cum"
  , colfeature = "sex"
)
icu <- plotLogGrowth(
  mydata = my_df
  , start_case = 1000
  , myvariable = "icu_now" #death_cum"
  , colfeature = "sex"
)
(home$graph | hosp$graph) / ( icu$graph | death$graph )  + 
  plot_annotation(
    title = "Covid-19 France Hospital data by genre"
    , subtitle = "by datapleth.io inspired by @jburnmurdoch"
    )
```




# Analysis of Emergency Data

Latest available data are from : `r max(france_official_emergency_dep$date)`

## France per departments {.tabset  .tabset-fade .tabset-pills}

### Total ER daily visits

```{r plotERTotdep}
h <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" ]
  , myvariable = "nbre_pass_tot"
  , colfeature = "region_name" 
  , facetfeature = "dep"
)
h
```


### ER daily visits for suspicion of COVID-19

```{r plotERCoviddep}
h <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" ]
  , myvariable = "nbre_pass_corona"
  , colfeature = "region_name" 
  , facetfeature = "dep"
)
h
```



### Daily hospitalization for COVID-19

```{r plotHospCoviddep}
h <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" ]
  , myvariable = "nbre_hospit_corona"
  , colfeature = "region_name" 
  , facetfeature = "dep"
)
h
```




### Total Daily medical acts (SOS Médecin)

```{r plotSOSTotaldep}
sos <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" ]
  , myvariable = "nbre_acte_tot"
  , colfeature = "region_name" 
  , facetfeature = "dep"
)
sos
```







### Daily medical acts (SOS Médecin) for suspicion of COVID-19

```{r plotSOSCoviddep}
sos <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" ]
  , myvariable = "nbre_acte_corona"
  , colfeature = "region_name" 
  , facetfeature = "dep"
)
sos
```



### Zoom : Ile de France

```{r plotIdfER}
idf_er_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Île-de-France"]
  , myvariable = "nbre_pass_tot"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France - Emergency "
)
idf_er_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Île-de-France"]
  , myvariable = "nbre_pass_corona"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France - Emergency "
)
idf_er_hosp <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Île-de-France"]
  , myvariable = "nbre_hospit_corona"
  , colfeature = "dep_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France - Emergency "
)
idf_sos_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Île-de-France"]
  , myvariable = "nbre_acte_tot"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France - SOS "
)
idf_sos_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Île-de-France"]
  , myvariable = "nbre_acte_corona"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Ile de France - SOS "
)


( idf_er_tot + idf_er_coro ) / idf_er_hosp / ( idf_sos_tot + idf_sos_coro)

```


### Zoom : Grand Est

```{r plotGEER}
idf_er_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Grand Est"]
  , myvariable = "nbre_pass_tot"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Grand Est - Emergency "
)
idf_er_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Grand Est"]
  , myvariable = "nbre_pass_corona"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Grand Est - Emergency "
)
idf_er_hosp <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Grand Est"]
  , myvariable = "nbre_hospit_corona"
  , colfeature = "dep_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Grand Est - Emergency "
)

idf_sos_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Grand Est"]
  , myvariable = "nbre_acte_tot"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Grand Est - SOS "
)
idf_sos_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_dep[ sursaud_cl_age_corona == "0" & region_name == "Grand Est"]
  , myvariable = "nbre_acte_corona"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 3
  , mytitle_base = "Grand Est - SOS "
)

( idf_er_tot + idf_er_coro ) / idf_er_hosp / ( idf_sos_tot + idf_sos_coro)

```

## France per regions (soon) {.tabset  .tabset-fade .tabset-pills}






## France Total



```{r plotErFT}
fra_er_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_total[ sursaud_cl_age_corona == "0"]
  , myvariable = "nbre_pass_tot"
  , colfeature = "fra"
  , facetfeature = "fra"
  , ncol = 3
  , mytitle_base = "France - Emergency "
)
fra_er_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_total[ sursaud_cl_age_corona == "0"]
  , myvariable = "nbre_pass_corona"
  , colfeature = "fra"
  , facetfeature = "fra"
  , ncol = 3
  , mytitle_base = "France - Emergency "
)
fra_er_hosp <- plotSmallMultipleCovid(
  my_data = france_official_emergency_total[ sursaud_cl_age_corona != "0"]
  , myvariable = "nbre_hospit_corona"
  , colfeature = "sursaud_cl_age_corona"
  , facetfeature = "fra"
  , ncol = 3
  , mytitle_base = "France - Emergency "
)

fra_sos_tot <- plotSmallMultipleCovid(
  my_data = france_official_emergency_total[ sursaud_cl_age_corona != "0"]
  , myvariable = "nbre_acte_tot"
  , colfeature = "fra"
  , facetfeature = "fra"
  , ncol = 3
  , mytitle_base = "France - SOS "
)
fra_sos_coro <- plotSmallMultipleCovid(
  my_data = france_official_emergency_total[ sursaud_cl_age_corona != "0"]
  , myvariable = "nbre_acte_corona"
  , colfeature = "fra"
  , facetfeature = "fra"
  , ncol = 3
  , mytitle_base = "France - SOS "
)

( fra_er_tot + fra_er_coro ) / fra_er_hosp / ( fra_sos_tot + fra_sos_coro)
```




