---
title: "Analysing COVID-19 (2019-nCoV) outbreak data with R - France"
draft: true
description: "A further exploration of COVID-19 incidence data using R tools and packages."
categories:
  - R
  - "COVID-19"
author:
  - name: datapleth
creative_commons: CC BY-SA
twitter:
  creator: "@datapleth"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 3
    self_contained: true
    number_sections: true
---

```{r loadLibs, include=FALSE}
library(dplyr)
library(data.table)
library(kableExtra)
library(DT)
library(ggplot2)
library(RColorBrewer)
library(plotly)
library(patchwork)
knitr::opts_chunk$set(fig.width=9, fig.height=9, echo=FALSE, warning = FALSE, message = FALSE) 
```




# Introduction & Objectives

This documents provides an analysis of Covid-19 outbreak in France based on 
offical data, as well as some comparison with Italy.

Situation will be reviewed at country level, regional level and department
level.

Visualisation and some elements of code are inspired by the best reference we
found during this period :

- John Burn-Murdoch ( )@jburnmurdoch ) who is a senior dataviz journalist at ft.com (see [his work here](https://www.ft.com/coronavirus-latest))
- Tim Churches with scientist at South Western Sydney Clinical School, UNSW Medicine & Ingham Institute of Applied Medical Research, Liverpool, Sydney, Australia. ( [link](https://swscs.med.unsw.edu.au) and his work [here](https://timchurches.github.io/blog/))

This report is published under creative common CC BY-SA, 

# France data  {.tabset}

## Data Sources

Since Friday march 27th, French government is publishing data for hospital and
health network.

From [data.gouv.fr](https://www.data.gouv.fr/fr/datasets/donnees-hospitalieres-relatives-a-lepidemie-de-covid-19/)

> Le présent jeu de données renseigne sur la situation hospitalières concernant
> l'épidémie de COVID-19 :

> Deux fichiers sont proposés :

> 1/ Les données hospitalières quotidiennes relatives à l'épidémie du COVID-19 par 
> département et sexe du patient : nombre de patients hospitalisés, nombre de 
> personnes actuellement en réanimation ou soins intensifs, nombre cumulé de 
> personnes retournées à domicile, nombre cumulé de personnes décédées.

> 2/ Les données quotidiennes relatives aux établissements hospitaliers par
> département : nombre cumulé de services ayant déclaré au moins un cas.
> Pour chacun des fichiers, une fiche de métadonnées est proposée.

> Attention : certains fichiers peuvent également comporter des anomalies. 
> N'hésitez pas à les signaler en commentaire. Santé publique France 
> communiquera les anomalies aux services métiers.


```{r sourceUri}
france_official_url <- "https://www.data.gouv.fr/fr/datasets/r/63352e38-d353-4b54-bfd1-f1b3ee1cabd7"
france_official_codebook_url <- "https://www.data.gouv.fr/fr/datasets/r/3f0f1885-25f4-4102-bbab-edec5a58e34a"

france_official_hospital_url <- "https://www.data.gouv.fr/fr/datasets/r/63352e38-d353-4b54-bfd1-f1b3ee1cabd7"
france_official_hospital_codebook_url <- "https://www.data.gouv.fr/fr/datasets/r/3f0f1885-25f4-4102-bbab-edec5a58e34a"

france_region_departements_url <- "https://www.data.gouv.fr/en/datasets/r/987227fb-dcb2-429e-96af-8979f97c9c84"

opencovid_fr_url <- "https://raw.githubusercontent.com/opencovid19-fr/data/master/dist/chiffres-cles.csv"
```


## Data Struture

```{r loadCleanFranceOfficialCodebook, echo=FALSE}
france_official_codebook <- data.table::as.data.table(read.csv(file = france_official_codebook_url, sep = ";"))
france_official_codebook %>%
  rename(Feature = Colonne) %>%
  mutate(Feature = c( "departement", "sex", "date", "hospitalized_now", "icu_now", "returned_home_now", "death_cum")) -> france_official_codebook

france_official_codebook %>%
  select(-Description_FR) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

We import these data and merge associate department with their Region names

```{r}
france_official_dep <- data.table::as.data.table(read.csv(file = france_official_url, sep = ";"))
france_region_departements <- data.table::as.data.table(read.csv(file = france_region_departements_url, sep = ","))
france_official_dep %>% 
  rename(
    department = dep
    , sex = sexe
    , date = jour
    , hospitalized_now = hosp
    , icu_now = rea
    , back_home_now = rad
    , death_cum = dc
  ) %>%
  mutate(
    date = as.Date(date)
  )-> france_official_dep
france_official_dep <- data.table::as.data.table(merge(
  france_official_dep
  , france_region_departements
  , by.x = "department"
  , by.y = "num_dep"
))
```

Complementary data with cumulative number of cases. This information
is not present in hospital data.

```{r}
opencovid_fr <- read.csv(opencovid_fr_url)
```




## Data per department

```{r viewHospitalDataPerDep}
DT::datatable(france_official_dep
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```

## Data per regions

We combine now department data per region.

```{r agregateHospPerRegion}
france_official_dep %>%
  group_by(region_name,sex,date) %>%
  summarise(
    hospitalized_now = sum(hospitalized_now, na.rm=TRUE)
    , icu_now = sum(icu_now, na.rm = TRUE)
    , back_home_now = sum(back_home_now, na.rm = TRUE)
    , death_cum = sum(death_cum, na.rm = TRUE)
    ) %>%
  ungroup() %>%
  data.table::as.data.table()-> france_official_reg
```



```{r viewHospitalDataPerRegion}
DT::datatable(france_official_reg
              #, extensions = 'FixedColumns'
              , filter = 'top'
              , class = 'cell-border stripe'
              , options = list(
                dom = 't'
                , scrollX = TRUE
                , scrollCollapse = TRUE)
)
```



# Visualise Hospital Data


```{r smallMultipleHostpital}
plotSmallMultipleCovid <- function(
  my_data = NULL
  , mygenre = 0
  , myvariable = "death_cum"
  , colfeature = "region_name"
  , facetfeature = "dep_name"
  , ncol = 10
){
  
  # Define the number of colors you want
  nb_cols <- length(unique(my_data[[colfeature]]))
  mycolors <- colorRampPalette(brewer.pal(8, "Dark2"))(nb_cols)
  
  my_data[ sex == 0 ] %>% 
    #group_by(department) %>%
    ggplot(
      aes_string(
        x="date"
        , y= myvariable
      )
    ) + 
    geom_bar(
      stat="identity"
      , aes_string(fill= colfeature)
    ) + 
    scale_fill_manual(values = mycolors) +
    facet_wrap(
      as.formula(paste(". ~ ", facetfeature))
      , ncol = ncol
      #, scales = "free_y"
    ) + 
    labs(
      y= "" #myvariable
      , title=paste0("France per department : ", myvariable)
      #, subtitle="Note: differing y-axis scales"
    ) +
    theme_minimal() +
    theme(
      #legend.position = "none"
      strip.text.x = element_text(
        size=5
        , face = "bold"
        , vjust = -0.0,
        margin = margin(-0.00, 0, 0, 0, "cm")
      )
      , strip.background = element_rect(
        color ="white"
        , fill ="white"
        , size = 0.5
        #, linetype="solid"
      )
      , axis.text.x = element_text(
        angle = 90
        , size = 8
      )
      #, plot.background = element_rect(fill = '#effffe', colour = '#effffe')
    ) -> fr
  return(fr)
}
```


## France per departments {.tabset  .tabset-fade .tabset-pills}

### Currently hospitalized

```{r plotHosp}
h <- plotSmallMultipleCovid(
  my_data = france_official_dep
  , mygenre = 0
  , myvariable = "hospitalized_now"
  , colfeature = "region_name"
)
h
```

### Currently back home

```{r plotHome}
ho <- plotSmallMultipleCovid(
  my_data = france_official_dep
  , mygenre = 0
  , myvariable = "back_home_now"
  , colfeature = "region_name"
)
ho
```

### Currently in ICU

```{r plotIcu}
i <- plotSmallMultipleCovid(
  my_data = france_official_dep
  , mygenre = 0
  , myvariable = "icu_now"
  , colfeature = "region_name"
)
i
```

### Cumulated deaths

```{r plotDeath}
g <- plotSmallMultipleCovid(
  my_data = france_official_dep
  , mygenre = 0
  , myvariable = "death_cum"
  , colfeature = "region_name"
)
g
```



## Ile de France per department

```{r plotIdf}
idf_home <- plotSmallMultipleCovid(
  my_data = france_official_dep[ region_name == "Île-de-France"]
  , mygenre = 0
  , myvariable = "back_home_now"
  , colfeature = "department"
  , ncol = 3
)
idf_hosp <- plotSmallMultipleCovid(
  my_data = france_official_dep[ region_name == "Île-de-France"]
  , mygenre = 0
  , myvariable = "hospitalized_now"
  , colfeature = "department"
  , ncol = 3
)
idf_dead <- plotSmallMultipleCovid(
  my_data = france_official_dep[ region_name == "Île-de-France"]
  , mygenre = 0
  , myvariable = "death_cum"
  , colfeature = "department"
  , ncol = 3
)
idf_icu <- plotSmallMultipleCovid(
  my_data = france_official_dep[ region_name == "Île-de-France"]
  , mygenre = 0
  , myvariable = "icu_now"
  , colfeature = "department"
  , ncol = 3
)


( idf_home + idf_hosp ) / ( idf_icu + idf_dead)

```




## France per Regions {.tabset .tabset-fade  .tabset-pills}

### Currently hospitalized 

```{r plotHospR}
h <- plotSmallMultipleCovid(
  my_data = france_official_reg
  , mygenre = 0
  , myvariable = "hospitalized_now"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 6
)
h
```

### Currently back home

```{r plotHomeR}
ho <- plotSmallMultipleCovid(
  my_data = france_official_reg
  , mygenre = 0
  , myvariable = "back_home_now"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 6
)
ho
```

### Currently in ICU

```{r plotIcuR}
i <- plotSmallMultipleCovid(
  my_data = france_official_reg
  , mygenre = 0
  , myvariable = "icu_now"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 6
)
i
```

### Cumulated deaths

```{r plotDeathR}
g <- plotSmallMultipleCovid(
  my_data = france_official_reg
  , mygenre = 0
  , myvariable = "death_cum"
  , colfeature = "region_name"
  , facetfeature = "region_name"
  , ncol = 6
)
g
```





## Comparison of cases growth {.tabset  .tabset-fade  .tabset-pills}

As the outbrek has not started at the same time in the various regions and
department of France, the best visualisation is based on growth of cumulated
cases from a given level, for instance, since the 100th death. 
These visuals and the code are inspired by the work of John Burn-Murdoch ( )@jburnmurdoch ) from the Financial Times.

```{r plotLogGrowthFunction}
library(shadowtext)
library(rlang)


plotLogGrowth <- function(
  mydata = NULL
  , myvariable = "hospitalized_now"
  , start_case = 500
  , colfeature = "department"
  ){
  
  ## Prepare data, each time series should start when they reach start_case
  mydata %>%
    group_by(!!as.name(colfeature)) %>%
    mutate(
      days_since_10 = as.numeric(
        date-min(
          date[!!as.name(myvariable) >= start_case]
        )
      )
    ) %>%
    ungroup() %>%
    filter(is.finite(days_since_10)) %>%
    group_by(!!as.name(colfeature)) %>%
    filter(
      sum(!!as.name(myvariable) >= start_case) >= 3 # at least 3 days visible
    ) %>%
    filter(
      !!as.name(myvariable) >= start_case
    ) -> my_df
  
  ## Compute colors 
  #nb_cols <- length(unique(my_df$department))
  nb_cols <- length(unique(my_df[[colfeature]]))
  mycolors <- colorRampPalette(brewer.pal(8, "Dark2"))(nb_cols)
  mycolors <- c(mycolors,"#DDDDDD","#DDDDDD","#DDDDDD")
  names(mycolors) = c(as.character(unique(my_df[[colfeature]])), "33% daily rise","25% daily rise","15% daily rise")
  
  ## compute max x for growth rates displayed as reference
  max_x <- max(my_df$days_since_10) + 2
  
  my_df %>% 
    bind_rows(
      tibble(!!colfeature := "33% daily rise", days_since_10 = 0:max_x) %>%
        mutate(!!myvariable := start_case*1.33^days_since_10)
    ) %>%
    bind_rows(
      tibble(!!colfeature := "25% daily rise", days_since_10 = 0:max_x) %>%
        mutate(!!myvariable := start_case*1.25^days_since_10)
    ) %>%
    bind_rows(
      tibble(!!colfeature := "15% daily rise", days_since_10 = 0:max_x) %>%
        mutate(!!myvariable := start_case*1.15^days_since_10)
    ) %>%
    ungroup() -> my_df
  
  
  my_df %>%
    # filter(days_since_100 <= 10) %>%
    ggplot(
      aes(
        x = days_since_10
        , y = !!as.name(myvariable)
        , col = !!as.name(colfeature)
      )
    ) +
    geom_hline(yintercept = start_case) +
    geom_vline(xintercept = 0) +
    geom_line(size = 0.8) +
    geom_point(pch = 21, size = 1) +
    scale_y_log10(
      expand = expand_scale(add = c(0,0.1))
      , breaks=c(100, 200, 500, 1000, 2000, 5000, 10000, 20000, 40000, 80000)
    ) +
    # scale_y_continuous(expand = expand_scale(add = c(0,100))) +
    scale_x_continuous(
      expand = expand_scale(add = c(0,1))
      , limits = c(0, max_x + 2)
    ) +
    theme_minimal() +
    theme(
      panel.grid.minor = element_blank()
      , legend.position = "none"
      , plot.margin = margin(3,15,3,3,"mm")
      #, plot.background = element_rect(fill = '#effffe', colour = '#effffe')
    ) +
    coord_cartesian(clip = "off") +
    scale_colour_manual(values = mycolors ) +
    #facet_wrap(facets = region_name ~ ., ncol = 3) +
    geom_shadowtext(
      aes(
        #label = paste0(" ",colfeature)
        label = paste0(" ", eval(parse(text = colfeature)))
      )
      , size = 3
      , hjust=0
      , vjust = 0
      , data = . %>%
        group_by(!!as.name(colfeature)) %>%
        top_n(1, days_since_10), bg.color = "#FEFEFE"
    ) +
    labs(
      x = paste0("Number of days since ",start_case,"th case")
      , y = "" #myvariable
      , subtitle = paste0("Growth of ",myvariable," (log scale)")
    ) -> g
  
  #ggplotly(g)
  return(list(
    graph = g
    , data = my_df
  ))
}
```

### Per departments

```{r logWorstDep}
my_df <- france_official_dep[ 
  #region_name == "Île-de-France" &
  sex == 0
  ] 

home <- plotLogGrowth(
  mydata = my_df
  , start_case = 100
  , myvariable = "back_home_now" #death_cum"
)
hosp <- plotLogGrowth(
  mydata = my_df
  , start_case = 500
  , myvariable = "hospitalized_now" #death_cum"
)
death <- plotLogGrowth(
  mydata = my_df
  , start_case = 40
  , myvariable = "death_cum" #death_cum"
)
icu <- plotLogGrowth(
  mydata = my_df
  , start_case = 100
  , myvariable = "icu_now" #death_cum"
)
(home$graph | hosp$graph) / ( icu$graph | death$graph )
```


### Per regions

```{r logWorstReg, echo=FALSE}
my_df <- france_official_reg[ 
  #region_name == "Île-de-France" &
  sex == 0
  ] 

home <- plotLogGrowth(
  mydata = my_df
  , start_case = 200
  , myvariable = "back_home_now" #death_cum"
  , colfeature = "region_name"
)
hosp <- plotLogGrowth(
  mydata = my_df
  , start_case = 700
  , myvariable = "hospitalized_now" #death_cum"
  , colfeature = "region_name"
)
death <- plotLogGrowth(
  mydata = my_df
  , start_case = 100
  , myvariable = "death_cum" #death_cum"
  , colfeature = "region_name"
)
icu <- plotLogGrowth(
  mydata = my_df
  , start_case = 200
  , myvariable = "icu_now" #death_cum"
  , colfeature = "region_name"
)
(home$graph | hosp$graph) / ( icu$graph | death$graph )
```





