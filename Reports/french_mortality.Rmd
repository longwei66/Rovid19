---
title: "Mortality in France, major events"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## configure path for data storage
data_storage_url <- "/media/lagrange/homes/lagrange_barthelemy/_DATA_STORE/"
```

```{r loadLibraries, message=FALSE, warning=FALSE, include=FALSE}
library(data.table)
library(dplyr)
library(geojsonio) # require protonlite install deb : libprotobuf-dev
library(geojsonsf)
library(mapproj)
library(kableExtra)
# Need a recent version of V8
# https://github.com/jeroen/V8
library(rmapshaper)
library(broom)
library(ggplot2)
library(ggthemes)
library(gghighlight)
```



# Introduction

The purpose of this article is to analyse mortality in France over time and
over french territory.

This work was inspired by several articles (see references section) and tweets.

The main one being the tweet of @coulmont comparing the current impact of 
covid-19 on french mortality and the 2003 heatwave which killed 14k people.

<center>
<blockquote class="twitter-tweet"><p lang="fr" dir="ltr">Le &quot;pic&quot; était moins élevé en 2020 qu&#39;en 2003, mais l&#39;aire sous la courbe (c&#39;est à dire les décès en plus de la moyenne) sont déjà deux fois plus nombreux... <a href="https://t.co/r0gImxUkTj">pic.twitter.com/r0gImxUkTj</a></p>&mdash; coulmont (@coulmont) <a href="https://twitter.com/coulmont/status/1256134197217046528?ref_src=twsrc%5Etfw">May 1, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</center>

The second one is from @jburnmurdoch and compares trend accross countries.

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">NEW: a lot of data on reported Covid deaths is highly suspect, so we’ve been looking into excess mortality — how many more people than usual have been dying around the world in recent weeks?<br><br>Story by me, <a href="https://twitter.com/ChrisGiles_?ref_src=twsrc%5Etfw">@ChrisGiles_</a> &amp; <a href="https://twitter.com/valentinaromei?ref_src=twsrc%5Etfw">@valentinaromei</a> (free to read): <a href="https://t.co/EiE5Q3OSmR">https://t.co/EiE5Q3OSmR</a> <a href="https://t.co/AiTdBnBma9">pic.twitter.com/AiTdBnBma9</a></p>&mdash; John Burn-Murdoch (@jburnmurdoch) <a href="https://twitter.com/jburnmurdoch/status/1254461123753054209?ref_src=twsrc%5Etfw">April 26, 2020</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

We will complement this time view by geographical view, visualizing the spatial
spread of mortality overtime.

# Get data {.tabset .tabset-face .tabset-pills}

## Data sources

We are combining five ressources :

- Mortality daily data per communes. In another notebook we prepared a dataset
combining latest official death data from french statistical bureau 
(https://insee.fr) for 2020 with historical official death data gathered by 
Christian Quest from https://data.cquest.org from insee.fr as well.
- French population over time per departements (from https://insee.fr)
- a spatial dataset containing the geographic borders of communes fortified as
a data frame to be plotted with ggplot.
- a spatial dataset containing the geographic borders of departements fortified as
a data frame to be plotted with ggplot.
- the list of all french communes with their insee codes and zip codes.


## Load data

We prepared in three separated notebook the datasets mentioned previously as
this preparation is time consuming. For instance the historical death data
contains 25 millions lines !

```{r loadDataFromFolder}
load(
  file = paste0(
    data_storage_url
    , "geo/france/clean/communes_lim_fortified.Rda"
    )
  )
load(
  file = paste0(
    data_storage_url
    , "insee.fr/codes/clean/communes_mapping.Rda"
    )
)
load(
  file = paste0(
    data_storage_url
    , "insee.fr/mortality/clean/dcd_all_clean.Rda"
    )
)
load(
  file = paste0(
    data_storage_url
    , "insee.fr/population/raw/estim-pop-dep-sexe-gca-1975-2020.Rda"
    )
)

```


# Create summarized data

## Total of death per day

### Agregate per day

```{r createDailyData}
dcd_daily <- copy(dcd_all_clean)
dcd_daily <- dcd_daily[ , .(daily_deaths = .N), by = .(date_deces) ]
```

### Add metadata 

```{r prepareDataVizDaily}
dcd_daily[, ':=' (
  year_death = as.factor(year(date_deces))
  , month_death = month(date_deces)
  , week_death = isoweek(date_deces)
  , dayofyear_death = as.numeric(strftime(date_deces, format = "%j"))
  , common_date_death = as.Date(paste0("2000-",format(date_deces, "%j")), "%Y-%j")
)
]
```

### Overview of the data

```{r overViewDaily}
head(dcd_daily) %>%
    kable() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

### Visualisation


```{r mortalityComparison}
g <- ggplot(
  data = dcd_daily[ date_deces > as.Date("1973-12-31") ]
  , group = year_death
  )
g <- g + geom_line(
  mapping = aes(
    x = common_date_death
    , y = daily_deaths
    , col = year_death
    )
  , size = 0.8)
g <- g + gghighlight(
  year_death %in% c(
    1989
    #, 1994, 1997,
    ,1997 ,1999, 2003, 2017, 2020
    )
  , use_direct_label = FALSE
  , unhighlighted_params = list(
      size = 0.3
      , alpha = 0.5
      )
  )
g <- g + scale_x_date(labels = function(x) format(x, "%d-%b")) 
g <- g + ggtitle("Daily mortality in France - France")
g <- g + xlab("Date") + ylab("nb of deaths")
g <- g + theme_minimal() + ylim(c(0,4000))
g
```

## Total of death per day and department

### Agregate per day

```{r createDailyDataDep}
dcd_by_department_daily <- copy(dcd_all_clean)
dcd_by_department_daily <- dcd_by_department_daily[ , .(daily_deaths = .N), by = .(code_lieu_deces,date_deces) ]
```

```{r MergeAndagregatePerDepartment}
dcd_by_department_daily <- merge(
  x = dcd_by_department_daily
  , y = communes_mapping
  , by.x = "code_lieu_deces"
  , by.y = "commune_insee_code"
  , allow.cartesian = TRUE
  )
```


```{r createDailyDataDep}
dcd_by_department_daily <- dcd_by_department_daily[ , .(daily_dep_deaths = sum(daily_deaths)), by = .(departement_insee_code,date_deces) ]
```



### Visualisation

```{r}
mypal <- c("#e7f0fa", #lighter than light blue
         "#c9e2f6", #light blue
         "#95cbee", #blue
         "#0099dc", #darker blue
         "#4ab04a", #green
         "#ffd73e", #yellow
         "#eec73a", #mustard
         "#e29421", #dark khaki (?)
         "#f05336", #orange red
         "#ce472e") #red

g <- ggplot(
    data = dcd_by_department_daily[ date_deces > as.Date("2019-01-01") ]
    , aes(
      x = date_deces
      , y = departement_insee_code
      , fill = daily_dep_deaths
      )
    ) +
    geom_tile(colour="white", linejoin = 2, 
              width=.9, height=.9) + theme_minimal()  +
    scale_fill_gradientn(
        colours = mypal
        # for daily death
        , values=c(0, 0.05, 0.1, 0.15, 0.2, 0.25, .3, .35, .4, .7, 1)
        , limits=c(0, 300)
        , na.value=rgb(246, 246, 246, max=255)
        #, labels=c("0", "1", "2k", "3k", "4k")
        , guide = guide_colourbar( barwidth= 0.6 )
        ) +
    #scale_y_discrete(limits = rev(levels(droplevels(dcd_by_department_daily$departement_insee_code)))) +
   # scale_x_continuous(expand=c(0,0), 
    #                   breaks=seq(1930, 2010, by=10)) +
    #(x=1963, xend=1963, y=0, yend=56.5, size=.7) +
    ggtitle("Evolution of daily deaths per department in France") +
    theme(
        axis.title.y=element_blank()
        , axis.text.y = element_text(size = 6)
        , axis.text.x = element_text(angle = 90)
        , panel.grid = element_blank()
        , axis.ticks.y=element_blank()
        )
g
```



### Add incidence

```{r}
population_per_dep_url <- "https://www.insee.fr/fr/statistiques/fichier/1893198/estim-pop-dep-sexe-gca-1975-2020.xls"
population_per_dep <- as.data.table(
  read.csv(
    file = population_per_dep_url
    , sep = ";")
  )
dcd_by_department_daily <- merge(
  x = dcd_by_department_daily,
  y = population_per_dep[ , .(`Code.Département`, Population)],
  by.x = "departement_insee_code",
  by.y = "Code.Département"
)
```


```{r}
dcd_by_department_daily[, death_incidence := (daily_dep_deaths / Population) * 100000]
```



## Total of death per day and insee_code (county/city)

### Agregate per day

```{r createDailyData}
dcd_by_code_daily <- copy(dcd_all_clean)
dcd_by_code_daily <- dcd_by_code_daily[ , .(daily_deaths = .N), by = .(code_lieu_deces,date_deces) ]
```


### Merge with insee mapping

```{r mergeDailWithInsee}
dcd_by_code_daily <- merge(
  x = dcd_by_code_daily
  , y = communes_mapping
  , by.x = "code_lieu_deces"
  , by.y = "commune_insee_code"
  , allow.cartesian = TRUE
  )
```

### Add metadata 

```{r prepareDataVizDaily}
dcd_by_code_daily[, ':=' (
  year_death = as.factor(year(date_deces))
  , month_death = month(date_deces)
  , week_death = isoweek(date_deces)
  , dayofyear_death = as.numeric(strftime(date_deces, format = "%j"))
  , common_date_death = as.Date(paste0("2000-",format(date_deces, "%j")), "%Y-%j")
)
]
```



### Overview of the data

```{r overViewDailybyCode}
head(dcd_by_code_daily) %>%
    kable() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```
### Choropleth for a specific date

```{r}
communes_results <- merge(
  x = dcd_by_code_daily[ date_deces == "2020-04-01" ]
  , y = communes_lim_fortified
  , by.x = "code_lieu_deces"
  , by.y = "id"
  , all.y = TRUE
  , allow.cartesian=TRUE
)
```

```{r}
p <- ggplot() +
  geom_polygon(
    data = communes_results, 
    aes(fill = daily_deaths, x = long, y = lat, group = group),
    color="grey", size = 0.02
  ) +
  scale_fill_viridis_c(option = "A", direction = -1) +
  #facet_wrap(facets = . ~ liste_shortname) +
  coord_map() +
  theme_tufte() +
  theme(
    axis.line=element_blank()
    , axis.text=element_blank()
    , axis.ticks=element_blank()
    , axis.title=element_blank()
    ) +
  ggtitle("Daily mortality - 2020-04-01 - France") +
  labs(fill = "nb_death")
p
```




## Total of death per week and insee_code (county/city)

### Agregate per week

```{r}
dcd_by_code_weekly <- copy(dcd_all_clean)
dcd_by_code_weekly <- dcd_by_code_weekly[ , .(count = .N), by = .(code_lieu_deces,week_death,year_death,month_death) ]
```


### Merge with insee mapping

```{r}
dcd_by_code_weekly <- merge(
  x = dcd_by_code_weekly
  , y = communes_mapping
  , by.x = "code_lieu_deces"
  , by.y = "commune_insee_code"
  , allow.cartesian = TRUE
  )
```

```{r}
head(dcd_by_code_weekly) %>%
    kable() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```



### Visualisation

```{r}
dcd_by_code_weekly_s <- dcd_by_code_weekly[ year_death > 1972 ]
dcd_by_code_weekly_s <- dcd_by_code_weekly_s[ , .( sum_c = sum(count) ) , by = .(year_death,week_death)] 

```


```{r}
library(gghighlight)
g <- ggplot(data = dcd_by_code_weekly_s, group = year_death)
g <- g + geom_line(mapping = aes(x = week_death, y = sum_c, col = as.factor(year_death)), size = 0.5)
g <- g + gghighlight(year_death %in% c(2020,2003,1989, 1994, 1997,1970))
#g <- g + scale_x_date(labels = function(x) format(x, "%d-%b")) 
g <- g + ggtitle("Mortalité quotidienne par année - France*** ")
g <- g + xlab("Week") + ylab("nb de décès")
g <- g + theme_minimal()
g
```


### Choropleth for a specific week

```{r}
communes_results_w <- merge(
  x = dcd_by_code_weekly[ week_death == 12]
  , y = communes_lim_fortified
  , by.x = "code_lieu_deces"
  , by.y = "id"
  , all.y = TRUE
  , allow.cartesian=TRUE
)
```

```{r}
p <- ggplot() +
  geom_polygon(
    data = communes_results_w[ 
      departement_insee_code %in% c(
      "92","91","93", "94","95","78", "75"
      # "69"
      # , "69", "13","33","19"
      ) 
      # | TRUE
      ], 
    aes(fill = count, x = long, y = lat, group = group),
    color="grey", size = 0.02
  ) +
  scale_fill_viridis_c(option = "A", direction = -1) +
  #facet_wrap(facets = . ~ liste_shortname) +
  coord_map() +
  theme_tufte() +
  theme(
    axis.line=element_blank()
    , axis.text=element_blank()
    , axis.ticks=element_blank()
    , axis.title=element_blank()
    ) +
  ggtitle("Weekly mortality - 2020 - Week 12 - France") +
  labs(fill = "nb_death")
p
```




# References

## Inspirations 
https://freakonometrics.hypotheses.org/60845

## Data Sources


```{r dataSources}
# 64Mo csv file
insee_dcd_all_url <- "http://data.cquest.org/insee_deces/insee_deces.csv.gz"
# 1.9Mo csv file 
insee_dcd_2020_remote_url <- "https://www.insee.fr/fr/statistiques/fichier/4470857/2020-04-30_detail.zip"
# France shapefile from data.gouv.fr
france_sp_url <- "https://data.datapleth.io/ext/france/spatial/communes-simple/communes-20190101.json"
## Important to use this version to get communes inside Paris & Marseilles.
france_geojson <- "https://github.com/gregoiredavid/france-geojson/raw/v2.0.2/communes.geojson"
# France insee code, zip code mapping
idf_insee_zip_url <- "https://www.data.gouv.fr/en/datasets/r/6d3428b2-3893-45a1-b404-2522a4e77d41"
```
